# TopoclimbCH JavaScript Architecture v2.0\n\n## ğŸ—ï¸ Architecture Moderne UnifiÃ©e\n\nCette nouvelle architecture remplace l'ancien systÃ¨me dÃ©sordonnÃ© par une structure modulaire, moderne et maintenable.\n\n## ğŸ“ Structure des Fichiers\n\n```\n/public/js/\nâ”œâ”€â”€ topoclimb.js              # Point d'entrÃ©e principal et orchestrateur\nâ”œâ”€â”€ common.js                 # Pont de compatibilitÃ© avec l'ancien systÃ¨me\nâ”œâ”€â”€ core/                     # Modules core du framework\nâ”‚   â”œâ”€â”€ index.js             # Framework de base avec systÃ¨me de modules\nâ”‚   â”œâ”€â”€ utils.js             # Utilitaires unifiÃ©s et modernes\nâ”‚   â”œâ”€â”€ api.js               # Client API avec cache et gestion d'erreurs\nâ”‚   â””â”€â”€ ui.js                # Composants UI (modales, toasts, lightbox)\nâ”œâ”€â”€ components/              # Composants rÃ©utilisables\nâ”‚   â”œâ”€â”€ swiss-map-manager.js        # Cartes suisses Swisstopo\nâ”‚   â”œâ”€â”€ interactive-map-manager.js  # Cartes avec clustering\nâ”‚   â”œâ”€â”€ region-map.js               # Carte spÃ©cifique aux rÃ©gions\nâ”‚   â”œâ”€â”€ weather-widget.js           # Widget mÃ©tÃ©o complet\nâ”‚   â”œâ”€â”€ geolocation-manager.js      # GÃ©olocalisation\nâ”‚   â”œâ”€â”€ site-form-manager.js        # Formulaires de sites\nâ”‚   â””â”€â”€ photo-gallery.js           # Galerie photos (Ã  crÃ©er)\nâ”œâ”€â”€ utils/                   # Utilitaires spÃ©cialisÃ©s\nâ”‚   â”œâ”€â”€ api-client.js        # Client HTTP (dÃ©prÃ©ciÃ©, remplacÃ© par core/api.js)\nâ”‚   â””â”€â”€ coordinates-helper.js # Utilitaires gÃ©ographiques\nâ”œâ”€â”€ pages/                   # Scripts spÃ©cifiques aux pages\nâ”‚   â”œâ”€â”€ regions/\nâ”‚   â”‚   â”œâ”€â”€ show-modern.js   # Version moderne de la page rÃ©gion\nâ”‚   â”‚   â”œâ”€â”€ show.js          # Ancien fichier (1764 lignes, Ã  dÃ©prÃ©cier)\nâ”‚   â”‚   â”œâ”€â”€ form.js          # Formulaire rÃ©gion\nâ”‚   â”‚   â””â”€â”€ index.js         # Liste des rÃ©gions\nâ”‚   â”œâ”€â”€ sites/               # Scripts pour les pages sites\nâ”‚   â”œâ”€â”€ sectors/             # Scripts pour les pages secteurs\nâ”‚   â””â”€â”€ routes/              # Scripts pour les pages voies\nâ””â”€â”€ analytics.js             # Tracking Google Analytics\n```\n\n## ğŸš€ Utilisation\n\n### Chargement de Base\n\n```html\n<!-- Dans le <head> ou avant </body> -->\n<script src=\"/js/topoclimb.js\" defer></script>\n<link rel=\"stylesheet\" href=\"/css/topoclimb-js.css\">\n```\n\n### Utilisation des Modules\n\n```javascript\n// Attendre que TopoclimbCH soit prÃªt\ndocument.addEventListener('DOMContentLoaded', async () => {\n    // Charger les modules requis\n    const [utils, api, ui] = await TopoclimbCH.modules.loadAll(['utils', 'api', 'ui']);\n    \n    // Utiliser les modules\n    const data = await api.getRegions();\n    ui.toast.success('RÃ©gions chargÃ©es !');\n    \n    const formattedDistance = utils.formatDistance(12.5);\n    console.log(formattedDistance); // \"12.5 km\"\n});\n```\n\n### SystÃ¨me d'Ã‰vÃ©nements\n\n```javascript\n// Ã‰couter un Ã©vÃ©nement\nTopoclimbCH.events.on('weather:updated', (data) => {\n    console.log('MÃ©tÃ©o mise Ã  jour:', data);\n});\n\n// Ã‰mettre un Ã©vÃ©nement\nTopoclimbCH.events.emit('map:sector-clicked', { sectorId: 123 });\n```\n\n## ğŸ§© Composants Principaux\n\n### 1. Framework Core (core/index.js)\n\n- **ModuleManager**: SystÃ¨me de modules avec gestion des dÃ©pendances\n- **EventSystem**: SystÃ¨me d'Ã©vÃ©nements global\n- **PromiseCache**: Cache intelligent pour les promesses\n- **Gestion d'erreurs**: Capture globale des erreurs JS\n\n### 2. Utilitaires (core/utils.js)\n\n```javascript\n// Fonctions de contrÃ´le de flux\nconst debouncedFn = TopoclimbCH.utils.debounce(myFunction, 300);\nconst throttledFn = TopoclimbCH.utils.throttle(myFunction, 100);\n\n// Formatage\nTopoclimbCH.utils.formatNumber(1234.56);     // \"1'234.56\"\nTopoclimbCH.utils.formatDistance(2.5);       // \"2.5 km\"\nTopoclimbCH.utils.formatDuration(125);       // \"2h05\"\n\n// SÃ©curitÃ©\nTopoclimbCH.utils.escapeHtml('<script>')     // \"&lt;script&gt;\"\nTopoclimbCH.utils.slugify('Escalade Valais'); // \"escalade-valais\"\n\n// DOM et gÃ©omÃ©trie\nTopoclimbCH.utils.isElementVisible(element);\nTopoclimbCH.utils.scrollToElement(target, { offset: 100 });\n\n// DÃ©tection d'environnement\nTopoclimbCH.utils.isMobile();               // true/false\nTopoclimbCH.utils.getCapabilities();        // objet avec capacitÃ©s\n```\n\n### 3. Client API (core/api.js)\n\n```javascript\n// APIs gÃ©nÃ©riques avec cache automatique\nconst regions = await TopoclimbCH.api.get('/api/regions');\nconst result = await TopoclimbCH.api.post('/api/sites', { name: 'Nouveau site' });\n\n// APIs spÃ©cialisÃ©es TopoclimbCH\nconst regions = await TopoclimbCH.api.getRegions();\nconst weather = await TopoclimbCH.api.getWeather(46.2044, 7.1432);\nconst nearestSites = await TopoclimbCH.api.getNearestSites(46.2044, 7.1432, 50, 10);\n\n// Gestion d'erreurs avancÃ©e\ntry {\n    const data = await TopoclimbCH.api.getRegion(123);\n} catch (error) {\n    if (error instanceof TopoclimbCH.ApiError) {\n        console.log('Erreur API:', error.status, error.message);\n    } else if (error instanceof TopoclimbCH.NetworkError) {\n        console.log('Erreur rÃ©seau:', error.message);\n    }\n}\n\n// Statistiques\nconsole.log(TopoclimbCH.api.getStats());\n// { requests: 42, errors: 2, averageTime: 245, cacheHitRate: 0.67 }\n```\n\n### 4. Composants UI (core/ui.js)\n\n```javascript\n// Modales\nTopoclimbCH.ui.modal.open('my-modal-id');\nTopoclimbCH.ui.modal.close();\n\n// Notifications toast\nTopoclimbCH.ui.toast.success('OpÃ©ration rÃ©ussie !');\nTopoclimbCH.ui.toast.error('Une erreur est survenue');\nTopoclimbCH.ui.toast.info('Information importante', { \n    duration: 10000,\n    action: {\n        text: 'Voir dÃ©tails',\n        handler: () => console.log('Action exÃ©cutÃ©e')\n    }\n});\n\n// Lightbox (auto-dÃ©tection avec data-lightbox)\n// <img src=\"image.jpg\" data-lightbox=\"gallery\" />\n```\n\n## ğŸ—ºï¸ Composants SpÃ©cialisÃ©s\n\n### Carte Suisse (swiss-map-manager.js)\n\n```javascript\nconst mapManager = new SwissMapManager('map-container', {\n    center: [46.8182, 8.2275],\n    zoom: 8,\n    showControls: true\n});\n\nmapManager.init();\nmapManager.addMarker(46.2044, 7.1432, { popup: 'Saillon' });\nmapManager.setLayer('satellite'); // pixelkarte, orthophoto, topo, hiking\n```\n\n### Carte Interactive avec Clustering (interactive-map-manager.js)\n\n```javascript\nconst interactiveMap = new InteractiveMapManager('map', {\n    enableClustering: true,\n    showHierarchy: true\n});\n\ninteractiveMap.init();\ninteractiveMap.loadClimbingData(); // Charge rÃ©gions, sites, secteurs\n```\n\n### Widget MÃ©tÃ©o (weather-widget.js)\n\n```javascript\nconst weather = new WeatherWidget('weather-container', {\n    coordinates: { lat: 46.2044, lng: 7.1432 },\n    showForecast: true,\n    showClimbingConditions: true,\n    updateInterval: 300000 // 5 minutes\n});\n\nweather.init();\n```\n\n### GÃ©olocalisation (geolocation-manager.js)\n\n```javascript\nconst geolocation = new GeolocationManager();\n// Auto-dÃ©tection des Ã©lÃ©ments avec data-geolocation\n```\n\n## ğŸ“± Pages Modernes\n\n### Page RÃ©gion (pages/regions/show-modern.js)\n\nRemplace l'ancien fichier monolithique de 1764 lignes par une architecture modulaire :\n\n- **Chargement dynamique** des composants selon les Ã©lÃ©ments prÃ©sents\n- **Auto-initialisation** intelligente\n- **Gestion d'erreurs** avec mode de secours\n- **Nettoyage automatique** des ressources\n\n```javascript\n// Auto-dÃ©tection et initialisation\n// Aucun code requis, la page se configure automatiquement\n```\n\n## ğŸ”„ Migration depuis l'Ancien SystÃ¨me\n\n### CompatibilitÃ© AssurÃ©e\n\nL'ancien code continue de fonctionner grÃ¢ce au pont de compatibilitÃ© :\n\n```javascript\n// Ancien code (continue de fonctionner)\nwindow.TopoclimbCH.Utils.debounce(fn, 300);\nnew APIClient().get('/api/regions');\n\n// Nouveau code (recommandÃ©)\nTopoclimbCH.utils.debounce(fn, 300);\nTopoclimbCH.api.getRegions();\n```\n\n### Ã‰tapes de Migration\n\n1. **Remplacer les inclusions**:\n   ```html\n   <!-- Ancien -->\n   <script src=\"/js/common.js\"></script>\n   <script src=\"/js/components/common.js\"></script>\n   \n   <!-- Nouveau -->\n   <script src=\"/js/topoclimb.js\" defer></script>\n   ```\n\n2. **Utiliser les nouveaux modules** progressivement\n3. **Migrer les fonctionnalitÃ©s** page par page\n4. **Supprimer l'ancien code** une fois migrÃ©\n\n## ğŸ› Debug et DÃ©veloppement\n\n### Mode Debug\n\n```javascript\n// Activer le debug\nTopoclimbCH.init({ debug: true });\n// ou ajouter ?debug=1 Ã  l'URL\n\n// Logs dÃ©taillÃ©s dans la console\n// Statistiques des modules\n// TraÃ§age des Ã©vÃ©nements\n```\n\n### Outils de DÃ©veloppement\n\n```javascript\n// Statistiques des modules\nconsole.log(TopoclimbCH.modules.getStats());\n\n// Ã‰tat du cache API\nconsole.log(TopoclimbCH.api.getStats());\n\n// Ã‰vÃ©nements actifs\nconsole.log(TopoclimbCH.events.getListeners());\n\n// CapacitÃ©s du navigateur\nconsole.log(TopoclimbCH.utils.getCapabilities());\n```\n\n## ğŸ”® FonctionnalitÃ©s AvancÃ©es\n\n### Lazy Loading Automatique\n\n```html\n<!-- Images lazy -->\n<img data-src=\"image.jpg\" class=\"lazy\" alt=\"Image\" />\n\n<!-- Composants lazy -->\n<div data-component=\"weather-widget\" data-lat=\"46.2044\" data-lng=\"7.1432\"></div>\n```\n\n### Service Worker et PWA\n\n```javascript\n// Cache automatique des ressources\n// Synchronisation en arriÃ¨re-plan\n// Mode hors-ligne\n```\n\n### Performance Monitoring\n\n```javascript\n// Monitoring automatique des performances\n// Alertes pour les opÃ©rations lentes (>100ms)\n// MÃ©triques de navigation\n```\n\n## ğŸ¯ Avantages de la Nouvelle Architecture\n\n### âœ… **Pour les DÃ©veloppeurs**\n- Code modulaire et rÃ©utilisable\n- TypeScript-ready avec JSDoc\n- Gestion d'erreurs centralisÃ©e\n- Hot-reload et debugging avancÃ©\n- Tests unitaires simplifiÃ©s\n\n### âœ… **Pour les Performances**\n- Chargement lazy des composants\n- Cache intelligent des APIs\n- Bundle splitting automatique\n- Optimisations de rendu\n- Service Worker intÃ©grÃ©\n\n### âœ… **Pour la Maintenance**\n- DÃ©pendances explicites\n- SÃ©paration des prÃ©occupations\n- Documentation automatique\n- Versionning des modules\n- RÃ©trocompatibilitÃ© assurÃ©e\n\n### âœ… **Pour l'ExpÃ©rience Utilisateur**\n- Temps de chargement rÃ©duits\n- Interactions fluides\n- Mode hors-ligne\n- Notifications intelligentes\n- AccessibilitÃ© amÃ©liorÃ©e\n\n## ğŸ“š Ressources\n\n- **Documentation API**: `/docs/api/`\n- **Tests**: `/tests/js/`\n- **Exemples**: `/examples/js/`\n- **Migration Guide**: `/docs/migration-v2.md`\n\n---\n\n**Version**: 2.0.0  \n**DerniÃ¨re mise Ã  jour**: Juillet 2025  \n**CompatibilitÃ©**: ES6+ (Babel pour IE11)  \n**DÃ©pendances**: Aucune (framework vanilla)  