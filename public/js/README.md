# TopoclimbCH JavaScript Architecture v2.0\n\n## 🏗️ Architecture Moderne Unifiée\n\nCette nouvelle architecture remplace l'ancien système désordonné par une structure modulaire, moderne et maintenable.\n\n## 📁 Structure des Fichiers\n\n```\n/public/js/\n├── topoclimb.js              # Point d'entrée principal et orchestrateur\n├── common.js                 # Pont de compatibilité avec l'ancien système\n├── core/                     # Modules core du framework\n│   ├── index.js             # Framework de base avec système de modules\n│   ├── utils.js             # Utilitaires unifiés et modernes\n│   ├── api.js               # Client API avec cache et gestion d'erreurs\n│   └── ui.js                # Composants UI (modales, toasts, lightbox)\n├── components/              # Composants réutilisables\n│   ├── swiss-map-manager.js        # Cartes suisses Swisstopo\n│   ├── interactive-map-manager.js  # Cartes avec clustering\n│   ├── region-map.js               # Carte spécifique aux régions\n│   ├── weather-widget.js           # Widget météo complet\n│   ├── geolocation-manager.js      # Géolocalisation\n│   ├── site-form-manager.js        # Formulaires de sites\n│   └── photo-gallery.js           # Galerie photos (à créer)\n├── utils/                   # Utilitaires spécialisés\n│   ├── api-client.js        # Client HTTP (déprécié, remplacé par core/api.js)\n│   └── coordinates-helper.js # Utilitaires géographiques\n├── pages/                   # Scripts spécifiques aux pages\n│   ├── regions/\n│   │   ├── show-modern.js   # Version moderne de la page région\n│   │   ├── show.js          # Ancien fichier (1764 lignes, à déprécier)\n│   │   ├── form.js          # Formulaire région\n│   │   └── index.js         # Liste des régions\n│   ├── sites/               # Scripts pour les pages sites\n│   ├── sectors/             # Scripts pour les pages secteurs\n│   └── routes/              # Scripts pour les pages voies\n└── analytics.js             # Tracking Google Analytics\n```\n\n## 🚀 Utilisation\n\n### Chargement de Base\n\n```html\n<!-- Dans le <head> ou avant </body> -->\n<script src=\"/js/topoclimb.js\" defer></script>\n<link rel=\"stylesheet\" href=\"/css/topoclimb-js.css\">\n```\n\n### Utilisation des Modules\n\n```javascript\n// Attendre que TopoclimbCH soit prêt\ndocument.addEventListener('DOMContentLoaded', async () => {\n    // Charger les modules requis\n    const [utils, api, ui] = await TopoclimbCH.modules.loadAll(['utils', 'api', 'ui']);\n    \n    // Utiliser les modules\n    const data = await api.getRegions();\n    ui.toast.success('Régions chargées !');\n    \n    const formattedDistance = utils.formatDistance(12.5);\n    console.log(formattedDistance); // \"12.5 km\"\n});\n```\n\n### Système d'Événements\n\n```javascript\n// Écouter un événement\nTopoclimbCH.events.on('weather:updated', (data) => {\n    console.log('Météo mise à jour:', data);\n});\n\n// Émettre un événement\nTopoclimbCH.events.emit('map:sector-clicked', { sectorId: 123 });\n```\n\n## 🧩 Composants Principaux\n\n### 1. Framework Core (core/index.js)\n\n- **ModuleManager**: Système de modules avec gestion des dépendances\n- **EventSystem**: Système d'événements global\n- **PromiseCache**: Cache intelligent pour les promesses\n- **Gestion d'erreurs**: Capture globale des erreurs JS\n\n### 2. Utilitaires (core/utils.js)\n\n```javascript\n// Fonctions de contrôle de flux\nconst debouncedFn = TopoclimbCH.utils.debounce(myFunction, 300);\nconst throttledFn = TopoclimbCH.utils.throttle(myFunction, 100);\n\n// Formatage\nTopoclimbCH.utils.formatNumber(1234.56);     // \"1'234.56\"\nTopoclimbCH.utils.formatDistance(2.5);       // \"2.5 km\"\nTopoclimbCH.utils.formatDuration(125);       // \"2h05\"\n\n// Sécurité\nTopoclimbCH.utils.escapeHtml('<script>')     // \"&lt;script&gt;\"\nTopoclimbCH.utils.slugify('Escalade Valais'); // \"escalade-valais\"\n\n// DOM et géométrie\nTopoclimbCH.utils.isElementVisible(element);\nTopoclimbCH.utils.scrollToElement(target, { offset: 100 });\n\n// Détection d'environnement\nTopoclimbCH.utils.isMobile();               // true/false\nTopoclimbCH.utils.getCapabilities();        // objet avec capacités\n```\n\n### 3. Client API (core/api.js)\n\n```javascript\n// APIs génériques avec cache automatique\nconst regions = await TopoclimbCH.api.get('/api/regions');\nconst result = await TopoclimbCH.api.post('/api/sites', { name: 'Nouveau site' });\n\n// APIs spécialisées TopoclimbCH\nconst regions = await TopoclimbCH.api.getRegions();\nconst weather = await TopoclimbCH.api.getWeather(46.2044, 7.1432);\nconst nearestSites = await TopoclimbCH.api.getNearestSites(46.2044, 7.1432, 50, 10);\n\n// Gestion d'erreurs avancée\ntry {\n    const data = await TopoclimbCH.api.getRegion(123);\n} catch (error) {\n    if (error instanceof TopoclimbCH.ApiError) {\n        console.log('Erreur API:', error.status, error.message);\n    } else if (error instanceof TopoclimbCH.NetworkError) {\n        console.log('Erreur réseau:', error.message);\n    }\n}\n\n// Statistiques\nconsole.log(TopoclimbCH.api.getStats());\n// { requests: 42, errors: 2, averageTime: 245, cacheHitRate: 0.67 }\n```\n\n### 4. Composants UI (core/ui.js)\n\n```javascript\n// Modales\nTopoclimbCH.ui.modal.open('my-modal-id');\nTopoclimbCH.ui.modal.close();\n\n// Notifications toast\nTopoclimbCH.ui.toast.success('Opération réussie !');\nTopoclimbCH.ui.toast.error('Une erreur est survenue');\nTopoclimbCH.ui.toast.info('Information importante', { \n    duration: 10000,\n    action: {\n        text: 'Voir détails',\n        handler: () => console.log('Action exécutée')\n    }\n});\n\n// Lightbox (auto-détection avec data-lightbox)\n// <img src=\"image.jpg\" data-lightbox=\"gallery\" />\n```\n\n## 🗺️ Composants Spécialisés\n\n### Carte Suisse (swiss-map-manager.js)\n\n```javascript\nconst mapManager = new SwissMapManager('map-container', {\n    center: [46.8182, 8.2275],\n    zoom: 8,\n    showControls: true\n});\n\nmapManager.init();\nmapManager.addMarker(46.2044, 7.1432, { popup: 'Saillon' });\nmapManager.setLayer('satellite'); // pixelkarte, orthophoto, topo, hiking\n```\n\n### Carte Interactive avec Clustering (interactive-map-manager.js)\n\n```javascript\nconst interactiveMap = new InteractiveMapManager('map', {\n    enableClustering: true,\n    showHierarchy: true\n});\n\ninteractiveMap.init();\ninteractiveMap.loadClimbingData(); // Charge régions, sites, secteurs\n```\n\n### Widget Météo (weather-widget.js)\n\n```javascript\nconst weather = new WeatherWidget('weather-container', {\n    coordinates: { lat: 46.2044, lng: 7.1432 },\n    showForecast: true,\n    showClimbingConditions: true,\n    updateInterval: 300000 // 5 minutes\n});\n\nweather.init();\n```\n\n### Géolocalisation (geolocation-manager.js)\n\n```javascript\nconst geolocation = new GeolocationManager();\n// Auto-détection des éléments avec data-geolocation\n```\n\n## 📱 Pages Modernes\n\n### Page Région (pages/regions/show-modern.js)\n\nRemplace l'ancien fichier monolithique de 1764 lignes par une architecture modulaire :\n\n- **Chargement dynamique** des composants selon les éléments présents\n- **Auto-initialisation** intelligente\n- **Gestion d'erreurs** avec mode de secours\n- **Nettoyage automatique** des ressources\n\n```javascript\n// Auto-détection et initialisation\n// Aucun code requis, la page se configure automatiquement\n```\n\n## 🔄 Migration depuis l'Ancien Système\n\n### Compatibilité Assurée\n\nL'ancien code continue de fonctionner grâce au pont de compatibilité :\n\n```javascript\n// Ancien code (continue de fonctionner)\nwindow.TopoclimbCH.Utils.debounce(fn, 300);\nnew APIClient().get('/api/regions');\n\n// Nouveau code (recommandé)\nTopoclimbCH.utils.debounce(fn, 300);\nTopoclimbCH.api.getRegions();\n```\n\n### Étapes de Migration\n\n1. **Remplacer les inclusions**:\n   ```html\n   <!-- Ancien -->\n   <script src=\"/js/common.js\"></script>\n   <script src=\"/js/components/common.js\"></script>\n   \n   <!-- Nouveau -->\n   <script src=\"/js/topoclimb.js\" defer></script>\n   ```\n\n2. **Utiliser les nouveaux modules** progressivement\n3. **Migrer les fonctionnalités** page par page\n4. **Supprimer l'ancien code** une fois migré\n\n## 🐛 Debug et Développement\n\n### Mode Debug\n\n```javascript\n// Activer le debug\nTopoclimbCH.init({ debug: true });\n// ou ajouter ?debug=1 à l'URL\n\n// Logs détaillés dans la console\n// Statistiques des modules\n// Traçage des événements\n```\n\n### Outils de Développement\n\n```javascript\n// Statistiques des modules\nconsole.log(TopoclimbCH.modules.getStats());\n\n// État du cache API\nconsole.log(TopoclimbCH.api.getStats());\n\n// Événements actifs\nconsole.log(TopoclimbCH.events.getListeners());\n\n// Capacités du navigateur\nconsole.log(TopoclimbCH.utils.getCapabilities());\n```\n\n## 🔮 Fonctionnalités Avancées\n\n### Lazy Loading Automatique\n\n```html\n<!-- Images lazy -->\n<img data-src=\"image.jpg\" class=\"lazy\" alt=\"Image\" />\n\n<!-- Composants lazy -->\n<div data-component=\"weather-widget\" data-lat=\"46.2044\" data-lng=\"7.1432\"></div>\n```\n\n### Service Worker et PWA\n\n```javascript\n// Cache automatique des ressources\n// Synchronisation en arrière-plan\n// Mode hors-ligne\n```\n\n### Performance Monitoring\n\n```javascript\n// Monitoring automatique des performances\n// Alertes pour les opérations lentes (>100ms)\n// Métriques de navigation\n```\n\n## 🎯 Avantages de la Nouvelle Architecture\n\n### ✅ **Pour les Développeurs**\n- Code modulaire et réutilisable\n- TypeScript-ready avec JSDoc\n- Gestion d'erreurs centralisée\n- Hot-reload et debugging avancé\n- Tests unitaires simplifiés\n\n### ✅ **Pour les Performances**\n- Chargement lazy des composants\n- Cache intelligent des APIs\n- Bundle splitting automatique\n- Optimisations de rendu\n- Service Worker intégré\n\n### ✅ **Pour la Maintenance**\n- Dépendances explicites\n- Séparation des préoccupations\n- Documentation automatique\n- Versionning des modules\n- Rétrocompatibilité assurée\n\n### ✅ **Pour l'Expérience Utilisateur**\n- Temps de chargement réduits\n- Interactions fluides\n- Mode hors-ligne\n- Notifications intelligentes\n- Accessibilité améliorée\n\n## 📚 Ressources\n\n- **Documentation API**: `/docs/api/`\n- **Tests**: `/tests/js/`\n- **Exemples**: `/examples/js/`\n- **Migration Guide**: `/docs/migration-v2.md`\n\n---\n\n**Version**: 2.0.0  \n**Dernière mise à jour**: Juillet 2025  \n**Compatibilité**: ES6+ (Babel pour IE11)  \n**Dépendances**: Aucune (framework vanilla)  