<!DOCTYPE html>
<html>
<head>
    <title>Test Cascade Formulaires</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        select, button { margin: 5px; padding: 8px; }
    </style>
</head>
<body>
    <h1>Test Cascade Formulaires - Debug</h1>
    
    <div class="test-section">
        <h2>1. Test API Regions</h2>
        <button onclick="testRegionsAPI()">Tester API Regions</button>
        <div id="regions-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Cascade R√©gion ‚Üí Sites</h2>
        <select id="region-selector">
            <option value="">Choisissez une r√©gion...</option>
        </select>
        <select id="site-selector" disabled>
            <option value="">Choisissez d'abord une r√©gion...</option>
        </select>
        <div id="cascade-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Cascade Site ‚Üí Secteurs</h2>
        <select id="sector-selector" disabled>
            <option value="">Choisissez d'abord un site...</option>
        </select>
        <div id="sectors-result"></div>
    </div>
    
    <script>
        // Test API Regions
        async function testRegionsAPI() {
            const resultDiv = document.getElementById('regions-result');
            try {
                const response = await fetch('/api/regions');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ API Regions OK - ${data.count} r√©gions trouv√©es</div>`;
                    populateRegions(data.data);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå API Regions Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Populate regions selector
        function populateRegions(regions) {
            const selector = document.getElementById('region-selector');
            selector.innerHTML = '<option value="">Choisissez une r√©gion...</option>';
            
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.name;
                selector.appendChild(option);
            });
            
            selector.addEventListener('change', loadSitesForRegion);
        }
        
        // Load sites for selected region
        async function loadSitesForRegion(event) {
            const regionId = event.target.value;
            const siteSelector = document.getElementById('site-selector');
            const resultDiv = document.getElementById('cascade-result');
            
            if (!regionId) {
                siteSelector.innerHTML = '<option value="">Choisissez d\'abord une r√©gion...</option>';
                siteSelector.disabled = true;
                return;
            }
            
            try {
                siteSelector.innerHTML = '<option value="">Chargement...</option>';
                siteSelector.disabled = false;
                
                const response = await fetch(`/api/regions/${regionId}/sites`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Sites charg√©s: ${data.data.length} sites</div>`;
                    populateSites(data.data);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur sites: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Populate sites selector
        function populateSites(sites) {
            const selector = document.getElementById('site-selector');
            selector.innerHTML = '<option value="">Choisissez un site...</option>';
            
            sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.id;
                option.textContent = site.name;
                selector.appendChild(option);
            });
            
            selector.addEventListener('change', loadSectorsForSite);
        }
        
        // Load sectors for selected site  
        async function loadSectorsForSite(event) {
            const siteId = event.target.value;
            const sectorSelector = document.getElementById('sector-selector');
            const resultDiv = document.getElementById('sectors-result');
            
            if (!siteId) {
                sectorSelector.innerHTML = '<option value="">Choisissez d\'abord un site...</option>';
                sectorSelector.disabled = true;
                return;
            }
            
            try {
                sectorSelector.innerHTML = '<option value="">Chargement...</option>';
                sectorSelector.disabled = false;
                
                const response = await fetch(`/api/sites/${siteId}/sectors`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Secteurs charg√©s: ${data.data.length} secteurs</div>`;
                    populateSectors(data.data);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erreur secteurs: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Populate sectors selector
        function populateSectors(sectors) {
            const selector = document.getElementById('sector-selector');
            selector.innerHTML = '<option value="">Choisissez un secteur...</option>';
            
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector.id;
                option.textContent = sector.name;
                selector.appendChild(option);
            });
        }
        
        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Test cascade formulaires pr√™t');
            testRegionsAPI();
        });
    </script>
</body>
</html>