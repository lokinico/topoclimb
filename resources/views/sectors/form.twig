{% extends "layouts/app.twig" %}

{% block body_class %}sector-form-page{% endblock %}

{% block title %}
    {% if sector.id %}
        Modifier le secteur {{ sector.name }}
    {% else %}
        Cr√©er un nouveau secteur
    {% endif %}
    - TopoclimbCH
{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/sectors') }}">Secteurs</a></li>
            {% if sector.id %}
                <li class="breadcrumb-item"><a href="{{ url('/sectors/' ~ sector.id) }}">{{ sector.name }}</a></li>
                <li class="breadcrumb-item active">Modifier</li>
            {% else %}
                <li class="breadcrumb-item active">Nouveau secteur</li>
            {% endif %}
        </ol>
    </nav>
    
    <h1>
        {% if sector.id %}
            Modifier le secteur {{ sector.name }}
        {% else %}
            Cr√©er un nouveau secteur
        {% endif %}
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <form action="{{ sector.id ? url('/sectors/' ~ sector.id) : url('/sectors') }}" 
              method="post" 
              enctype="multipart/form-data" 
              class="sector-form-content" 
              id="sector-form"
              data-sector-id="{{ sector.id|default('') }}"
              data-site-id="{{ sector.site_id|default(parent_site.id|default('')) }}"
              autocomplete="off">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if sector.id %}
                <input type="hidden" name="_method" value="PUT">
            {% endif %}

            <!-- Informations de base -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations de base</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group mb-3">
                                <label for="name" class="form-label">
                                    Nom du secteur <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="name" id="name" class="form-control" 
                                       value="{{ sector.name|default('') }}" 
                                       required maxlength="255" 
                                       aria-describedby="name-help">
                                <small id="name-help" class="form-text text-muted">
                                    Nom complet du secteur d'escalade
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="code" class="form-label">
                                    Code <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="code" id="code" class="form-control" 
                                       value="{{ sector.code|default('') }}" 
                                       required maxlength="50" 
                                       aria-describedby="code-help">
                                <small id="code-help" class="form-text text-muted">
                                    Identifiant unique du secteur
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Hi√©rarchie g√©ographique: R√©gion ‚Üí Site -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="region_id" class="form-label">
                                    R√©gion <span class="text-danger">*</span>
                                </label>
                                <select name="region_id" id="region_id" class="form-control" 
                                        required aria-describedby="region-help">
                                    <option value="">S√©lectionnez une r√©gion</option>
                                    {% for region in regions %}
                                        <option value="{{ region.id }}" 
                                                {% if sector.region_id == region.id %}selected{% endif %}>
                                            {{ region.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small id="region-help" class="form-text text-muted">
                                    R√©gion g√©ographique du secteur
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="site_id" class="form-label">Site d'escalade</label>
                                <div class="position-relative">
                                    <select name="site_id" id="site_id" class="form-control" 
                                            disabled aria-describedby="site-help">
                                        <option value="">Choisissez d'abord une r√©gion...</option>
                                        {% if sector.site_id %}
                                            <option value="{{ sector.site_id }}" selected>{{ sector.site_name|default('Site inconnu') }}</option>
                                        {% endif %}
                                    </select>
                                    <div class="loading-spinner d-none" id="site-loading">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <small id="site-help" class="form-text text-muted">
                                    Site d'escalade auquel appartient ce secteur (optionnel)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <!-- Espace r√©serv√© pour autres champs -->
                        </div>
                        
                    </div>

                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea name="description" id="description" class="form-control" 
                                  rows="4" aria-describedby="description-help">{{ sector.description|default('') }}</textarea>
                        <small id="description-help" class="form-text text-muted">
                            Description g√©n√©rale du secteur d'escalade
                        </small>
                    </div>
                </div>
            </div>

            <!-- Localisation -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Localisation</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_lat" class="form-label">Latitude</label>
                                <input type="number" name="coordinates_lat" id="coordinates_lat" 
                                       class="form-control" 
                                       value="{{ sector.coordinates_lat|default('') }}" 
                                       step="0.00000001" min="-90" max="90"
                                       aria-describedby="lat-help">
                                <small id="lat-help" class="form-text text-muted">
                                    Latitude en degr√©s d√©cimaux (ex: 46.2044)
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_lng" class="form-label">Longitude</label>
                                <input type="number" name="coordinates_lng" id="coordinates_lng" 
                                       class="form-control" 
                                       value="{{ sector.coordinates_lng|default('') }}" 
                                       step="0.00000001" min="-180" max="180"
                                       aria-describedby="lng-help">
                                <small id="lng-help" class="form-text text-muted">
                                    Longitude en degr√©s d√©cimaux (ex: 6.1432)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_swiss_e" class="form-label">Coordonn√©es suisses E (LV95)</label>
                                <div class="input-group">
                                    <input type="text" name="coordinates_swiss_e" id="coordinates_swiss_e" 
                                           class="form-control" 
                                           value="{{ sector.coordinates_swiss_e|default('') }}" 
                                           aria-describedby="ch-e-help"
                                           placeholder="2600000">
                                    <div class="input-group-text">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                id="convert-to-gps-btn" 
                                                title="Convertir LV95 ‚Üí GPS">
                                            <i class="fa fa-arrow-right"></i> GPS
                                        </button>
                                    </div>
                                </div>
                                <small id="ch-e-help" class="form-text text-muted">
                                    Coordonn√©e Est du syst√®me suisse LV95
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_swiss_n" class="form-label">Coordonn√©es suisses N (LV95)</label>
                                <div class="input-group">
                                    <input type="text" name="coordinates_swiss_n" id="coordinates_swiss_n" 
                                           class="form-control" 
                                           value="{{ sector.coordinates_swiss_n|default('') }}" 
                                           aria-describedby="ch-n-help"
                                           placeholder="1200000">
                                    <div class="input-group-text">
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                id="convert-to-lv95-btn" 
                                                title="Convertir GPS ‚Üí LV95">
                                            <i class="fa fa-arrow-left"></i> LV95
                                        </button>
                                    </div>
                                </div>
                                <small id="ch-n-help" class="form-text text-muted">
                                    Coordonn√©e Nord du syst√®me suisse LV95
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="coordinate-conversion-help mb-3">
                        <div class="alert alert-info">
                            <strong><i class="fa fa-info-circle"></i> Conversion de coordonn√©es:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Utilisez <i class="fa fa-exchange-alt"></i> pour convertir entre GPS et LV95</li>
                                <li>Les coordonn√©es GPS sont utilis√©es pour l'affichage sur cartes</li>
                                <li>Les coordonn√©es LV95 sont le syst√®me officiel suisse</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="altitude" class="form-label">Altitude</label>
                        <div class="input-group">
                            <input type="number" name="altitude" id="altitude" class="form-control" 
                                   value="{{ sector.altitude|default('') }}" 
                                   min="0" max="9000" aria-describedby="altitude-help">
                            <span class="input-group-text">m</span>
                        </div>
                        <small id="altitude-help" class="form-text text-muted">
                            Altitude approximative du secteur en m√®tres
                        </small>
                    </div>

                    <!-- Carte interactive -->
                    <div class="map-section">
                        <label class="form-label">S√©lectionner la position sur la carte</label>
                        <div id="sector-map" 
                             data-coordinates-lat="{{ sector.coordinates_lat|default('') }}" 
                             data-coordinates-lng="{{ sector.coordinates_lng|default('') }}"
                             style="height: 350px; border-radius: 0.375rem; border: 1px solid #dee2e6;"></div>
                        <small class="form-text text-muted mt-2">
                            Cliquez sur la carte pour placer le marker du secteur
                        </small>
                    </div>
                </div>
            </div>

            <!-- Caract√©ristiques -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Caract√©ristiques</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="height" class="form-label">Hauteur moyenne</label>
                                <div class="input-group">
                                    <input type="number" name="height" id="height" step="0.1" class="form-control" 
                                           value="{{ sector.height|default('') }}" 
                                           min="0" max="2000" aria-describedby="height-help">
                                    <span class="input-group-text">m</span>
                                </div>
                                <small id="height-help" class="form-text text-muted">
                                    Hauteur moyenne des voies du secteur
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="orientation" class="form-label">Orientation du secteur</label>
                                <select name="orientation" id="orientation" class="form-control">
                                    <option value="">S√©lectionnez une orientation</option>
                                    <option value="N" {% if sector.orientation == 'N' %}selected{% endif %}>Nord (N)</option>
                                    <option value="NE" {% if sector.orientation == 'NE' %}selected{% endif %}>Nord-Est (NE)</option>
                                    <option value="E" {% if sector.orientation == 'E' %}selected{% endif %}>Est (E)</option>
                                    <option value="SE" {% if sector.orientation == 'SE' %}selected{% endif %}>Sud-Est (SE)</option>
                                    <option value="S" {% if sector.orientation == 'S' %}selected{% endif %}>Sud (S)</option>
                                    <option value="SW" {% if sector.orientation == 'SW' %}selected{% endif %}>Sud-Ouest (SW)</option>
                                    <option value="W" {% if sector.orientation == 'W' %}selected{% endif %}>Ouest (W)</option>
                                    <option value="NW" {% if sector.orientation == 'NW' %}selected{% endif %}>Nord-Ouest (NW)</option>
                                </select>
                                <small class="form-text text-muted">
                                    Orientation principale du secteur (exposition dominante)
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations d'acc√®s -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations d'acc√®s</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="access_info" class="form-label">Informations d'acc√®s</label>
                        <textarea name="access_info" id="access_info" class="form-control" 
                                  rows="4" aria-describedby="access-help">{{ sector.access_info|default('') }}</textarea>
                        <small id="access-help" class="form-text text-muted">
                            Instructions pour acc√©der au secteur (parking, marche d'approche, etc.)
                        </small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="access_time" class="form-label">Temps d'acc√®s</label>
                                <div class="input-group">
                                    <input type="number" name="access_time" id="access_time" class="form-control" 
                                           value="{{ sector.access_time|default('') }}" 
                                           min="0" max="1440" aria-describedby="access-time-help">
                                    <span class="input-group-text">min</span>
                                </div>
                                <small id="access-time-help" class="form-text text-muted">
                                    Temps de marche estim√© en minutes (max 24h)
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="approach" class="form-label">Marche d'approche</label>
                                <textarea name="approach" id="approach" class="form-control" 
                                          rows="3" aria-describedby="approach-help">{{ sector.approach|default('') }}</textarea>
                                <small id="approach-help" class="form-text text-muted">
                                    Instructions d√©taill√©es pour l'approche √† pied
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="parking_info" class="form-label">Informations de parking</label>
                        <textarea name="parking_info" id="parking_info" class="form-control" 
                                  rows="3" aria-describedby="parking-help">{{ sector.parking_info|default('') }}</textarea>
                        <small id="parking-help" class="form-text text-muted">
                            Indications sur les parkings disponibles
                        </small>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Images</h3>
                </div>
                <div class="card-body">
                    <div class="media-upload-section">
                        <div class="form-group mb-3">
                            <label for="media_file" class="form-label">Ajouter une image</label>
                            <div class="custom-file">
                                <input type="file" name="media_file" id="media_file" 
                                       class="custom-file-input" accept="image/*" 
                                       aria-describedby="media-help">
                                <label class="custom-file-label" for="media_file">Choisir un fichier</label>
                            </div>
                            <small id="media-help" class="form-text text-muted">
                                Formats support√©s: JPG, PNG, GIF. Taille max: 5MB
                            </small>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="media_title" class="form-label">Titre de l'image</label>
                            <input type="text" name="media_title" id="media_title" 
                                   class="form-control" aria-describedby="media-title-help">
                            <small id="media-title-help" class="form-text text-muted">
                                Titre descriptif de l'image (optionnel)
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Type d'image</label>
                            <div class="form-check">
                                <input type="radio" id="media_type_main" name="media_relationship_type" 
                                       value="main" class="form-check-input" checked>
                                <label class="form-check-label" for="media_type_main">
                                    Image principale
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="radio" id="media_type_gallery" name="media_relationship_type" 
                                       value="gallery" class="form-check-input">
                                <label class="form-check-label" for="media_type_gallery">
                                    Galerie
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="radio" id="media_type_topo" name="media_relationship_type" 
                                       value="topo" class="form-check-input">
                                <label class="form-check-label" for="media_type_topo">
                                    Topo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Images existantes -->
                    {% if media and media|length > 0 %}
                        <div class="existing-media mt-4">
                            <h5>Images existantes</h5>
                            <div class="media-gallery row">
                                {% for item in media %}
                                    <div class="col-md-4 mb-3">
                                        <div class="media-item">
                                            {% if item.file_path %}
                                                {% set image_url = item.file_path starts with 'http' ? item.file_path : url(item.file_path starts with '/' ? item.file_path : '/' ~ item.file_path) %}
                                                <img src="{{ image_url }}" 
                                                     class="img-fluid rounded" 
                                                     alt="{{ item.title|default('Image du secteur') }}"
                                                     style="height: 150px; width: 100%; object-fit: cover;">
                                            {% endif %}
                                            
                                            <div class="media-info mt-2">
                                                <h6 class="mb-1">{{ item.title|default('Image ' ~ item.id) }}</h6>
                                                <small class="text-muted">
                                                    Type: Gallery
                                                </small>
                                            </div>
                                            
                                            <div class="media-actions mt-2">
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger media-delete-btn"
                                                        data-media-id="{{ item.id }}"
                                                        data-csrf-token="{{ csrf_token }}">
                                                    <i class="fa fa-trash"></i> Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- √âtat -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">√âtat</h3>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" name="active" id="active" class="form-check-input" 
                               value="1" {% if not sector or sector.active != 0 %}checked{% endif %}>
                        <label for="active" class="form-check-label">
                            Secteur actif
                        </label>
                        <small class="form-text text-muted d-block">
                            D√©cochez pour d√©sactiver temporairement le secteur
                        </small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions d-flex gap-3 mb-5">
                <button type="submit" class="btn btn-primary">
                    {% if sector.id %}
                        <i class="fa fa-save"></i> Mettre √† jour
                    {% else %}
                        <i class="fa fa-plus"></i> Cr√©er le secteur
                    {% endif %}
                </button>
                
                <a href="{{ sector.id ? url('/sectors/' ~ sector.id) : url('/sectors') }}" 
                   class="btn btn-secondary">
                    <i class="fa fa-times"></i> Annuler
                </a>
                
                {% if sector.id %}
                    <button type="button" class="btn btn-outline-danger ms-auto" 
                            data-bs-toggle="modal" data-bs-target="#deleteSectorModal">
                        <i class="fa fa-trash"></i> Supprimer
                    </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Sidebar avec aide -->
    <div class="col-lg-4">
        <div class="help-section card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fa fa-info-circle text-info"></i> Aide
                </h5>
            </div>
            <div class="card-body">
                <div class="help-item mb-3">
                    <h6>Qu'est-ce qu'un secteur ?</h6>
                    <p class="small text-muted">
                        Un secteur est une zone d'escalade homog√®ne regroupant plusieurs voies 
                        sur une m√™me paroi ou formation rocheuse (ex: "Secteur Sud", "Le Mur Jaune").
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Code du secteur</h6>
                    <p class="small text-muted">
                        Utilisez un code court et descriptif (ex: "SUD_A", "MUR_JAUNE", "DALLE_EST"). 
                        √âvitez les espaces et utilisez des underscores.
                    </p>
                </div>
                

                <div class="help-item mb-3">
                    <h6>Orientation</h6>
                    <p class="small text-muted">
                        <strong>Nord:</strong> Ombre, frais, s√©chage lent<br>
                        <strong>Sud:</strong> Soleil toute la journ√©e, chaud<br>
                        <strong>Est:</strong> Soleil matinal, ombre l'apr√®s-midi<br>
                        <strong>Ouest:</strong> Ombre le matin, soleil l'apr√®s-midi
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Coordonn√©es GPS</h6>
                    <p class="small text-muted">
                        Placez le point au pied du secteur, l√† o√π commencent les voies. 
                        Cela facilite la navigation pour les grimpeurs.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Coordonn√©es suisses LV95</h6>
                    <p class="small text-muted">
                        Syst√®me officiel suisse pour la cartographie pr√©cise. 
                        Format: E ~2'600'000 / N ~1'200'000 pour la Suisse centrale.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Temps d'acc√®s</h6>
                    <p class="small text-muted">
                        Indiquez le temps depuis le parking le plus proche jusqu'au pied 
                        du secteur. Comptez pour un marcheur moyen avec mat√©riel.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Types d'images</h6>
                    <p class="small text-muted">
                        <strong>Principale:</strong> Vue g√©n√©rale du secteur<br>
                        <strong>Topo:</strong> Sch√©ma avec trac√© des voies<br>
                        <strong>Galerie:</strong> Photos d'ambiance, d√©tails
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Marche d'approche</h6>
                    <p class="small text-muted">
                        D√©crivez le chemin depuis le parking: sentiers, cairns, 
                        points de rep√®re, difficult√©s particuli√®res, √©quipement n√©cessaire.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Parking</h6>
                    <p class="small text-muted">
                        Indiquez les places disponibles, tarifs √©ventuels, 
                        horaires, alternatives en cas de saturation.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Hauteur moyenne</h6>
                    <p class="small text-muted">
                        Hauteur typique des voies du secteur. Aide les grimpeurs 
                        √† pr√©voir la longueur de corde n√©cessaire.
                    </p>
                </div>
                
                <div class="help-item">
                    <h6>Hi√©rarchie</h6>
                    <p class="small text-muted">
                        <strong>R√©gion</strong> ‚Üí <strong>Site</strong> ‚Üí <strong>Secteur</strong> ‚Üí <strong>Voie</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de suppression -->
{% if sector.id %}
<div class="modal fade" id="deleteSectorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer le secteur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir supprimer le secteur <strong>{{ sector.name }}</strong> ?</p>
                <p class="text-danger small">
                    <i class="fa fa-exclamation-triangle"></i>
                    Cette action est irr√©versible et supprimera √©galement toutes les voies associ√©es.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <form method="POST" action="{{ url('/sectors/' ~ sector.id) }}" class="d-inline" autocomplete="on">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        Supprimer d√©finitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Leaflet pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- TopoclimbCH JavaScript Components -->
<script src="/js/coordinate-converter.js"></script>

<script nonce="{{ csp_nonce }}">
// Initialiser le convertisseur global
window.TopoclimbCoordinateConverter = new CoordinateConverter();
console.log('üåç Convertisseur de coordonn√©es initialis√©');

// Activation imm√©diate du select site si r√©gion s√©lectionn√©e
(function() {
    const regionSelect = document.getElementById('region_id');
    const siteSelect = document.getElementById('site_id');
    
    if (regionSelect && siteSelect && regionSelect.value && siteSelect.disabled) {
        console.log('üöÄ Activation imm√©diate site select');
        siteSelect.disabled = false;
        
        // Charger sites imm√©diatement
        if (window.fetch) {
            fetch('/api/regions/' + regionSelect.value + '/sites')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        siteSelect.innerHTML = '<option value="">Aucun site s√©lectionn√©</option>';
                        data.data.forEach(site => {
                            const option = document.createElement('option');
                            option.value = site.id;
                            option.textContent = site.name;
                            if ('{{ sector.site_id|default("") }}' && site.id == '{{ sector.site_id|default("") }}') {
                                option.selected = true;
                            }
                            siteSelect.appendChild(option);
                        });
                        console.log('‚úÖ Sites charg√©s imm√©diatement');
                    }
                })
                .catch(err => console.log('Erreur chargement sites:', err));
        }
    }
})();
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    console.log('üèîÔ∏è Initialisation gestionnaire de formulaire secteur TopoclimbCH');
    
    // Initialiser le cascade r√©gion‚Üísite
    try {
        initRegionSiteCascade();
    } catch (error) {
        console.error('‚ùå Erreur initialisation cascade:', error);
    }
    
    // Fallback simple si erreur
    setTimeout(function() {
        const siteSelect = document.getElementById('site_id');
        const regionSelect = document.getElementById('region_id');
        
        if (siteSelect && siteSelect.disabled && regionSelect && regionSelect.value) {
            console.log('üîß Activation fallback site select');
            siteSelect.disabled = false;
        }
    }, 1000);
    
    try {
        // Note: SectorFormManager temporairement d√©sactiv√© (en d√©veloppement)
        console.log('‚úÖ Gestionnaire de formulaire secteur (mode fallback)');
        
        // Si coordonn√©es existantes dans le formulaire, les utiliser
        {% if sector.coordinates_lat and sector.coordinates_lng %}
            console.log('üìç Coordonn√©es existantes d√©tect√©es: {{ sector.coordinates_lat }}, {{ sector.coordinates_lng }}');
        {% endif %}
        
        // Gestion conversion coordonn√©es
        const convertToGpsBtn = document.getElementById('convert-to-gps-btn');
        const convertToLv95Btn = document.getElementById('convert-to-lv95-btn');
        
        if (convertToGpsBtn) {
            convertToGpsBtn.addEventListener('click', async function() {
                await convertLV95toGPS();
            });
        }
        
        if (convertToLv95Btn) {
            convertToLv95Btn.addEventListener('click', async function() {
                await convertGPStoLV95();
            });
        }
        
        // Gestion du fichier m√©dia
        const mediaFileInput = document.getElementById('media_file');
        if (mediaFileInput) {
            mediaFileInput.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (label) {
                    const fileName = this.files[0]?.name || 'Choisir un fichier';
                    label.textContent = fileName;
                }
            });
        }
        
        // Gestion suppression m√©dias
        document.addEventListener('click', function(e) {
            if (e.target.closest('.media-delete-btn')) {
                const button = e.target.closest('.media-delete-btn');
                const mediaId = button.getAttribute('data-media-id');
                const csrfToken = button.getAttribute('data-csrf-token');
                
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cette image ?')) {
                    deleteMedia(mediaId, csrfToken, button);
                }
            }
        });
        
        // √âcouter les √©v√©nements personnalis√©s
        window.TopoclimbCH.Events.on('form:validation-error', function(errors) {
            console.warn('‚ö†Ô∏è Erreurs de validation:', errors);
        });
        
        window.TopoclimbCH.Events.on('form:media-deleted', function(mediaId) {
            console.log('üóëÔ∏è M√©dia supprim√©:', mediaId);
            showNotification('Image supprim√©e avec succ√®s', 'success');
        });
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation formulaire secteur:', error);
        
        // Notification d'erreur (fallback safe)
        if (window.TopoclimbCH && TopoclimbCH.Notifications) {
            TopoclimbCH.Notifications.error('Erreur d\'initialisation du formulaire');
        } else {
            console.warn('‚ö†Ô∏è TopoclimbCH.Notifications non disponible');
        }
        
        // Fallback vers fonctionnalit√© basique si erreur
        initBasicFormFunctionality();
    }
});

/**
 * Fonctionnalit√© de base en cas d'erreur avec les composants avanc√©s
 */
function initBasicFormFunctionality() {
    console.log('üîÑ Initialisation fonctionnalit√© de base formulaire secteur');
    
    // G√©n√©ration code basique
    const nameInput = document.getElementById('name');
    const codeInput = document.getElementById('code');
    
    if (nameInput && codeInput) {
        nameInput.addEventListener('input', function() {
            if (!codeInput.value || codeInput.dataset.autoGenerated === 'true') {
                const generatedCode = this.value
                    .toUpperCase()
                    .replace(/[^A-Z0-9]/g, '_')
                    .substring(0, 20);
                codeInput.value = generatedCode;
                codeInput.dataset.autoGenerated = 'true';
            }
        });
        
        codeInput.addEventListener('input', function() {
            this.dataset.autoGenerated = 'false';
        });
    }
    
    // Gestion fichier basique
    const mediaFileInput = document.getElementById('media_file');
    if (mediaFileInput) {
        mediaFileInput.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (label) {
                const fileName = this.files[0]?.name || 'Choisir un fichier';
                label.textContent = fileName;
            }
        });
    }
}

/**
 * Convertit les coordonn√©es LV95 vers GPS
 */
async function convertLV95toGPS() {
    const eastingInput = document.getElementById('coordinates_swiss_e');
    const northingInput = document.getElementById('coordinates_swiss_n');
    const latInput = document.getElementById('coordinates_lat');
    const lngInput = document.getElementById('coordinates_lng');
    
    if (!eastingInput || !northingInput || !latInput || !lngInput) {
        console.error('‚ùå Champs de coordonn√©es non trouv√©s');
        return;
    }
    
    const easting = parseFloat(eastingInput.value);
    const northing = parseFloat(northingInput.value);
    
    if (isNaN(easting) || isNaN(northing)) {
        showNotification('Veuillez saisir des coordonn√©es LV95 valides', 'warning');
        return;
    }
    
    try {
        showNotification('Conversion LV95 ‚Üí GPS en cours...', 'info');
        
        const result = await window.TopoclimbCoordinateConverter.convertLV95toWGS84(easting, northing);
        
        // Mettre √† jour les champs GPS
        latInput.value = result.latitude.toFixed(8);
        lngInput.value = result.longitude.toFixed(8);
        
        // Validation visuelle
        latInput.classList.add('coordinates-valid');
        lngInput.classList.add('coordinates-valid');
        
        showNotification('‚úÖ Conversion LV95 ‚Üí GPS r√©ussie!', 'success');
        
        // Mettre √† jour la carte si elle existe
        if (typeof formManager !== 'undefined' && formManager.updateMapFromCoordinates) {
            formManager.updateMapFromCoordinates(result.latitude, result.longitude);
        }
        
    } catch (error) {
        console.error('‚ùå Erreur conversion LV95‚ÜíGPS:', error);
        showNotification(`Erreur conversion: ${error.message}`, 'error');
    }
}

/**
 * Convertit les coordonn√©es GPS vers LV95
 */
async function convertGPStoLV95() {
    const latInput = document.getElementById('coordinates_lat');
    const lngInput = document.getElementById('coordinates_lng');
    const eastingInput = document.getElementById('coordinates_swiss_e');
    const northingInput = document.getElementById('coordinates_swiss_n');
    
    if (!latInput || !lngInput || !eastingInput || !northingInput) {
        console.error('‚ùå Champs de coordonn√©es non trouv√©s');
        return;
    }
    
    const latitude = parseFloat(latInput.value);
    const longitude = parseFloat(lngInput.value);
    
    if (isNaN(latitude) || isNaN(longitude)) {
        showNotification('Veuillez saisir des coordonn√©es GPS valides', 'warning');
        return;
    }
    
    try {
        showNotification('Conversion GPS ‚Üí LV95 en cours...', 'info');
        
        const result = await window.TopoclimbCoordinateConverter.convertWGS84toLV95(longitude, latitude);
        
        // Mettre √† jour les champs LV95
        eastingInput.value = Math.round(result.easting).toString();
        northingInput.value = Math.round(result.northing).toString();
        
        // Validation visuelle
        eastingInput.classList.add('coordinates-valid');
        northingInput.classList.add('coordinates-valid');
        
        showNotification('‚úÖ Conversion GPS ‚Üí LV95 r√©ussie!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erreur conversion GPS‚ÜíLV95:', error);
        showNotification(`Erreur conversion: ${error.message}`, 'error');
    }
}

/**
 * Supprime un m√©dia
 */
async function deleteMedia(mediaId, csrfToken, buttonElement) {
    try {
        // Indicateur de chargement
        const originalContent = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;
        
        const response = await fetch(`/api/media/${mediaId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Supprimer l'√©l√©ment du DOM
            const mediaItem = buttonElement.closest('.col-md-4');
            if (mediaItem) {
                mediaItem.style.transition = 'opacity 0.3s';
                mediaItem.style.opacity = '0';
                setTimeout(() => mediaItem.remove(), 300);
            }
            showNotification('Image supprim√©e avec succ√®s', 'success');
        } else {
            throw new Error(data.error || 'Erreur lors de la suppression');
        }
        
    } catch (error) {
        console.error('Erreur suppression m√©dia:', error);
        showNotification(`Erreur: ${error.message}`, 'error');
        
        // Restaurer le bouton
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
    }
}

/**
 * Affiche une notification √† l'utilisateur
 */
function showNotification(message, type = 'info') {
    // Utiliser les notifications TopoclimbCH si disponibles
    if (typeof TopoclimbCH !== 'undefined' && TopoclimbCH.Notifications) {
        TopoclimbCH.Notifications[type](message);
    } else {
        // Fallback vers alert
        alert(message);
    }
}

/**
 * Initialise le syst√®me cascade R√©gion ‚Üí Site (version simplifi√©e)
 */
function initRegionSiteCascade() {
    console.log('üîó Initialisation cascade r√©gion‚Üísite (version simplifi√©e)');
    
    const regionSelect = document.getElementById('region_id');
    const siteSelect = document.getElementById('site_id');

    if (!regionSelect || !siteSelect) {
        console.warn('‚ùå √âl√©ments cascade r√©gion‚Üísite non trouv√©s');
        return;
    }

    // √âtat initial
    const initialRegionId = regionSelect.value;
    const initialSiteId = '{{ sector.site_id|default("") }}';
    
    console.log('üîç √âtat initial - R√©gion:', initialRegionId, 'Site:', initialSiteId);

    // Si r√©gion d√©j√† s√©lectionn√©e, activer le select site
    if (initialRegionId) {
        siteSelect.disabled = false;
        loadSitesForRegion(initialRegionId, initialSiteId);
    }

    // √âv√©nement changement de r√©gion
    regionSelect.addEventListener('change', function() {
        const regionId = this.value;
        console.log('üîÑ Changement r√©gion:', regionId);
        
        if (regionId) {
            siteSelect.disabled = false;
            loadSitesForRegion(regionId);
        } else {
            siteSelect.disabled = true;
            siteSelect.innerHTML = '<option value="">Choisissez d\'abord une r√©gion...</option>';
        }
    });

    async function loadSitesForRegion(regionId, selectedSiteId = null) {
        console.log(`üì° Chargement sites pour r√©gion ${regionId}`);
        
        siteSelect.innerHTML = '<option value="">Chargement...</option>';
        
        try {
            const response = await fetch(`/api/regions/${regionId}/sites`);
            const data = await response.json();
            
            console.log('üì° R√©ponse API:', data);
            
            if (data.success && data.data) {
                siteSelect.innerHTML = '<option value="">Aucun site s√©lectionn√© (optionnel)</option>';
                
                data.data.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = site.name;
                    if (selectedSiteId && site.id == selectedSiteId) {
                        option.selected = true;
                    }
                    siteSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${data.data.length} sites charg√©s`);
            } else {
                throw new Error(data.error || 'Erreur API');
            }
        } catch (error) {
            console.error('‚ùå Erreur chargement sites:', error);
            siteSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            alert('Erreur lors du chargement des sites: ' + error.message);
        }
    }
}
</script>

<style>
.form-section .card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-section .card-title {
    color: #495057;
    font-weight: 600;
}

.custom-file-label::after {
    content: "Parcourir";
}

.media-item {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    background: #f8f9fa;
}

.help-section {
    position: sticky;
    top: 2rem;
}

.help-item h6 {
    color: #495057;
    font-weight: 600;
}

.form-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

/* Styles pour carte dans formulaire */
#sector-map {
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    transition: border-color 0.2s;
}

#sector-map:hover {
    border-color: #007bff;
}

/* Validation visuelle pour coordonn√©es */
.coordinates-valid {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.coordinates-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

@media (max-width: 768px) {
    .help-section {
        position: static;
        margin-top: 2rem;
    }
    
    #sector-map {
        height: 250px !important;
    }
}
</style>
{% endblock %}