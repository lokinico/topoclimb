{% extends "layouts/app.twig" %}

{% block title %}
    {% if sector.id %}
        Modifier le secteur {{ sector.name }}
    {% else %}
        Ajouter un secteur
    {% endif %}
    - TopoclimbCH
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>
            {% if sector.id %}
                Modifier le secteur {{ sector.name }}
            {% else %}
                Ajouter un secteur
            {% endif %}
        </h1>
    </div>
    
    <div class="form-container">
        <form action="{{ sector.id ? url('/sectors/' ~ sector.id ~ '/edit') : url('/sectors/create') }}" 
              method="post" 
              enctype="multipart/form-data" 
              class="form form-horizontal">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="form-group">
                <label for="book_id">Site</label>
                <select name="book_id" id="book_id" class="form-control" required aria-describedby="book-help">
                    <option value="">Sélectionnez un site</option>
                    {% for book in books %}
                        <option value="{{ book.id }}" {% if sector.book_id == book.id %}selected{% endif %}>
                            {{ book.name }}
                        </option>
                    {% endfor %}
                </select>
                <small id="book-help" class="form-text text-muted">Site d'escalade auquel appartient ce secteur</small>
            </div>
            
            <div class="form-group">
                <label for="region_id">Région</label>
                <select name="region_id" id="region_id" class="form-control" aria-describedby="region-help">
                    <option value="">Sélectionnez une région</option>
                    {% for region in regions %}
                        <option value="{{ region.id }}" {% if sector.region_id == region.id %}selected{% endif %}>
                            {{ region.name }}
                        </option>
                    {% endfor %}
                </select>
                <small id="region-help" class="form-text text-muted">Région géographique du secteur</small>
            </div>
            
            <div class="form-group">
                <label for="name">Nom</label>
                <input type="text" name="name" id="name" class="form-control" value="{{ sector.name }}" 
                       required maxlength="255" aria-describedby="name-help">
                <small id="name-help" class="form-text text-muted">Nom complet du secteur</small>
            </div>
            
            <div class="form-group">
                <label for="code">Code</label>
                <input type="text" name="code" id="code" class="form-control" value="{{ sector.code }}" 
                       required maxlength="50" aria-describedby="code-help">
                <small id="code-help" class="form-text text-muted">Identifiant unique du secteur</small>
            </div>
            
            <div class="form-group">
                <label for="color">Couleur</label>
                <input type="color" name="color" id="color" class="form-control" 
                       value="{{ sector.color|default('#FF0000') }}" aria-describedby="color-help">
                <small id="color-help" class="form-text text-muted">Couleur utilisée pour identifier ce secteur</small>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea name="description" id="description" class="form-control" 
                          rows="5" aria-describedby="description-help">{{ sector.description }}</textarea>
                <small id="description-help" class="form-text text-muted">Description détaillée du secteur</small>
            </div>
            
            <div class="form-section">
                <h3>Informations d'accès</h3>
                
                <div class="form-group">
                    <label for="access_info">Informations d'accès</label>
                    <textarea name="access_info" id="access_info" class="form-control" 
                              rows="3" aria-describedby="access-info-help">{{ sector.access_info }}</textarea>
                    <small id="access-info-help" class="form-text text-muted">Instructions d'accès au secteur</small>
                </div>
                
                <div class="form-group">
                    <label for="access_time">Temps d'accès (en minutes)</label>
                    <input type="number" name="access_time" id="access_time" class="form-control" 
                           value="{{ sector.access_time }}" min="0" max="1440" 
                           aria-describedby="access-time-help">
                    <small id="access-time-help" class="form-text text-muted">Temps de marche estimé en minutes (max 24h)</small>
                </div>
                
                <div class="form-group">
                    <label for="approach">Marche d'approche</label>
                    <textarea name="approach" id="approach" class="form-control" 
                              rows="3" aria-describedby="approach-help">{{ sector.approach }}</textarea>
                    <small id="approach-help" class="form-text text-muted">Instructions détaillées pour l'approche à pied</small>
                </div>
                
                <div class="form-group">
                    <label for="parking_info">Informations de parking</label>
                    <textarea name="parking_info" id="parking_info" class="form-control" 
                              rows="3" aria-describedby="parking-help">{{ sector.parking_info }}</textarea>
                    <small id="parking-help" class="form-text text-muted">Indications sur les parkings disponibles</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Caractéristiques</h3>
                
                <div class="form-group">
                    <label for="altitude">Altitude (en mètres)</label>
                    <input type="number" name="altitude" id="altitude" class="form-control" 
                           value="{{ sector.altitude }}" min="0" max="9000" aria-describedby="altitude-help">
                    <small id="altitude-help" class="form-text text-muted">Altitude du secteur en mètres</small>
                </div>
                
                <div class="form-group">
                    <label for="height">Hauteur (en mètres)</label>
                    <input type="number" name="height" id="height" step="0.1" class="form-control" 
                           value="{{ sector.height }}" min="0" max="2000" aria-describedby="height-help">
                    <small id="height-help" class="form-text text-muted">Hauteur moyenne du secteur en mètres</small>
                </div>
                
                <div class="form-group">
                    <label>Expositions</label>
                    <div class="checkbox-group" role="group" aria-label="Expositions du secteur">
                        {% for exposure in exposures %}
                            <div class="form-check">
                                <input type="checkbox" 
                                       name="exposures[]" 
                                       id="exposure_{{ exposure.id }}" 
                                       value="{{ exposure.id }}" 
                                       {% if exposure.id in currentExposures %}checked{% endif %}
                                       aria-describedby="exposure-help">
                                <label for="exposure_{{ exposure.id }}">
                                    {{ exposure.name }} ({{ exposure.code }})
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <small id="exposure-help" class="form-text text-muted">Orientations cardinales du secteur</small>
                </div>
                
                <div class="form-group">
                    <label>Exposition principale</label>
                    <div class="radio-group" role="radiogroup" aria-label="Exposition principale du secteur">
                        {% for exposure in exposures %}
                            <div class="form-check">
                                <input type="radio" 
                                       name="primary_exposure" 
                                       id="primary_exposure_{{ exposure.id }}" 
                                       value="{{ exposure.id }}" 
                                       {% if exposure.id == primaryExposure %}checked{% endif %}
                                       aria-describedby="primary-exposure-help">
                                <label for="primary_exposure_{{ exposure.id }}">
                                    {{ exposure.name }} ({{ exposure.code }})
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <small id="primary-exposure-help" class="form-text text-muted">Orientation principale du secteur</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Coordonnées</h3>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="coordinates_lat">Latitude</label>
                        <input type="number" name="coordinates_lat" id="coordinates_lat" class="form-control" 
                               value="{{ sector.coordinates_lat }}" step="0.00000001" min="-90" max="90"
                               aria-describedby="lat-help">
                        <small id="lat-help" class="form-text text-muted">Latitude en degrés décimaux (ex: 46.2044)</small>
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label for="coordinates_lng">Longitude</label>
                        <input type="number" name="coordinates_lng" id="coordinates_lng" class="form-control" 
                               value="{{ sector.coordinates_lng }}" step="0.00000001" min="-180" max="180"
                               aria-describedby="lng-help">
                        <small id="lng-help" class="form-text text-muted">Longitude en degrés décimaux (ex: 6.1432)</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="coordinates_swiss_e">Coordonnées suisses E</label>
                        <input type="text" name="coordinates_swiss_e" id="coordinates_swiss_e" class="form-control" 
                               value="{{ sector.coordinates_swiss_e }}" aria-describedby="ch-e-help">
                        <small id="ch-e-help" class="form-text text-muted">Coordonnée Est du système suisse</small>
                    </div>
                    
                    <div class="form-group col-md-6">
                        <label for="coordinates_swiss_n">Coordonnées suisses N</label>
                        <input type="text" name="coordinates_swiss_n" id="coordinates_swiss_n" class="form-control" 
                               value="{{ sector.coordinates_swiss_n }}" aria-describedby="ch-n-help">
                        <small id="ch-n-help" class="form-text text-muted">Coordonnée Nord du système suisse</small>
                    </div>
                </div>
                
                <div class="map-picker">
                    <div id="map" style="height: 400px;" aria-label="Carte pour sélectionner la position"></div>
                    <button type="button" class="btn btn-secondary" id="locate-button">
                        <i class="icon-location" aria-hidden="true"></i> Ma position
                    </button>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Images</h3>
                
                <div class="media-upload-section">
                    <div class="form-group">
                        <label for="media_file">Ajouter une image</label>
                        <div class="custom-file">
                            <input type="file" name="media_file" id="media_file" class="custom-file-input" 
                                   accept="image/*" aria-describedby="media-help">
                            <label class="custom-file-label" for="media_file">Choisir un fichier</label>
                        </div>
                        <small id="media-help" class="form-text text-muted">Formats supportés: JPG, PNG, GIF. Taille max: 5MB</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="media_title">Titre de l'image</label>
                        <input type="text" name="media_title" id="media_title" class="form-control" 
                               aria-describedby="media-title-help">
                        <small id="media-title-help" class="form-text text-muted">Titre descriptif de l'image (optionnel)</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Type d'image</label>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="media_type_main" name="media_relationship_type" 
                                   value="main" class="custom-control-input" checked>
                            <label class="custom-control-label" for="media_type_main">Image principale</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="media_type_gallery" name="media_relationship_type" 
                                   value="gallery" class="custom-control-input">
                            <label class="custom-control-label" for="media_type_gallery">Galerie</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="media_type_topo" name="media_relationship_type" 
                                   value="topo" class="custom-control-input">
                            <label class="custom-control-label" for="media_type_topo">Topo</label>
                        </div>
                    </div>
                </div>
                
                {% if media and media|length > 0 %}
                    <div class="existing-media mt-4">
                        <h4>Images existantes</h4>
                        
                        <div class="media-gallery row">
                            {% for item in media %}
                                <div class="media-item col-md-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-img-container" style="height: 200px; overflow: hidden;">
                                            {% if item.file_path %}
                                                <img src="{{ url(item.file_path) }}" class="card-img-top" 
                                                     alt="{{ item.title|default('Image du secteur') }}" 
                                                     style="object-fit: cover; height: 100%; width: 100%;">
                                            {% else %}
                                                <div class="text-center p-5 bg-light">Image non disponible</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="card-body">
                                            <h5 class="card-title text-truncate">
                                                {{ item.title|default('Image ' ~ item.id) }}
                                            </h5>
                                            
                                            <p class="card-text small text-muted">
                                                Type: {{ item.relationship_type|default('gallery')|capitalize }}
                                            </p>
                                            
                                            <div class="btn-group btn-group-sm d-flex">
                                                <button type="button" 
                                                        class="btn btn-outline-primary w-100"
                                                        data-toggle="modal" 
                                                        data-target="#editMediaModal"
                                                        data-media-id="{{ item.id }}"
                                                        data-media-title="{{ item.title }}"
                                                        data-relationship-type="{{ item.relationship_type|default('gallery') }}">
                                                    <i class="fa fa-edit mr-1"></i> Modifier
                                                </button>
                                                
                                                <button type="button" 
                                                        class="btn btn-outline-danger w-100 media-delete-btn"
                                                        data-media-id="{{ item.id }}"
                                                        data-csrf-token="{{ csrf_token }}">
                                                    <i class="fa fa-trash mr-1"></i> Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="active">État</label>
                <select name="active" id="active" class="form-control" aria-describedby="active-help">
                    <option value="1" {% if sector.active != 0 %}selected{% endif %}>Actif</option>
                    <option value="0" {% if sector.active == 0 %}selected{% endif %}>Inactif</option>
                </select>
                <small id="active-help" class="form-text text-muted">L'état détermine si le secteur est visible pour les utilisateurs</small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    {% if sector.id %}
                        Mettre à jour
                    {% else %}
                        Créer
                    {% endif %}
                </button>
                
                <a href="{{ url('/sectors' ~ (sector.id ? '/' ~ sector.id : '')) }}" class="btn btn-secondary" role="button">
                    Annuler
                </a>
            </div>
        </form>
    </div>
    
    {# Modal pour modifier les médias #}
    <div class="modal fade" id="editMediaModal" tabindex="-1" role="dialog" aria-labelledby="editMediaModalTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMediaModalTitle">Modifier l'image</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                
                <form id="editMediaForm" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="media_id" id="edit_media_id">
                        
                        <div class="form-group">
                            <label for="edit_media_title">Titre</label>
                            <input type="text" name="title" id="edit_media_title" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label>Type d'image</label>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="edit_media_type_main" name="relationship_type" 
                                       value="main" class="custom-control-input">
                                <label class="custom-control-label" for="edit_media_type_main">Image principale</label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="edit_media_type_gallery" name="relationship_type" 
                                       value="gallery" class="custom-control-input">
                                <label class="custom-control-label" for="edit_media_type_gallery">Galerie</label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="edit_media_type_topo" name="relationship_type" 
                                       value="topo" class="custom-control-input">
                                <label class="custom-control-label" for="edit_media_type_topo">Topo</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_media_file">Remplacer l'image</label>
                            <div class="custom-file">
                                <input type="file" name="media_file" id="edit_media_file" class="custom-file-input" accept="image/*">
                                <label class="custom-file-label" for="edit_media_file">Choisir un fichier</label>
                            </div>
                            <small class="form-text text-muted">Laissez vide pour conserver l'image actuelle</small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation de la carte
            const map = L.map('map').setView([46.8, 8.2], 8); // Centre sur la Suisse
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            let marker;
            
            // Initialiser le marqueur si des coordonnées sont disponibles
            {% if sector.coordinates_lat and sector.coordinates_lng %}
                marker = L.marker([{{ sector.coordinates_lat }}, {{ sector.coordinates_lng }}]).addTo(map);
                map.setView([{{ sector.coordinates_lat }}, {{ sector.coordinates_lng }}], 15);
            {% endif %}
            
            // Mettre à jour les coordonnées lors d'un clic sur la carte
            map.on('click', function(e) {
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker(e.latlng).addTo(map);
                
                document.getElementById('coordinates_lat').value = e.latlng.lat.toFixed(8);
                document.getElementById('coordinates_lng').value = e.latlng.lng.toFixed(8);
                
                // Convertir en coordonnées suisses si nécessaire
                // Cette conversion nécessiterait une bibliothèque spécifique
            });
            
            // Bouton de localisation
            document.getElementById('locate-button').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        if (marker) {
                            map.removeLayer(marker);
                        }
                        
                        marker = L.marker([lat, lng]).addTo(map);
                        map.setView([lat, lng], 15);
                        
                        document.getElementById('coordinates_lat').value = lat.toFixed(8);
                        document.getElementById('coordinates_lng').value = lng.toFixed(8);
                    }, function(error) {
                        console.error("Erreur de géolocalisation:", error.message);
                        alert("Impossible d'obtenir votre position. Erreur: " + error.message);
                    }, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                } else {
                    alert("La géolocalisation n'est pas prise en charge par votre navigateur");
                }
            });
            
            // Afficher le nom du fichier sélectionné
            document.getElementById('media_file').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Choisir un fichier';
                const label = e.target.nextElementSibling;
                label.textContent = fileName;
            });
            
            document.getElementById('edit_media_file').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Choisir un fichier';
                const label = e.target.nextElementSibling;
                label.textContent = fileName;
            });
            
            // Initialiser la modal d'édition
            $('#editMediaModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const mediaId = button.data('media-id');
                const mediaTitle = button.data('media-title');
                const relationshipType = button.data('relationship-type');
                
                const modal = $(this);
                modal.find('#edit_media_id').val(mediaId);
                modal.find('#edit_media_title').val(mediaTitle);
                
                // Sélectionner le type approprié
                modal.find(`#edit_media_type_${relationshipType}`).prop('checked', true);
                
                // Définir l'action du formulaire
                const formAction = `/media/${mediaId}/update`;
                modal.find('#editMediaForm').attr('action', formAction);
            });
            
            // Gestion de la suppression des médias
            document.querySelectorAll('.media-delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) {
                        const mediaId = this.dataset.mediaId;
                        const csrfToken = this.dataset.csrfToken;
                        
                        // Créer un formulaire pour la requête POST de suppression
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/media/${mediaId}/delete`;
                        form.style.display = 'none';
                        
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrf_token';
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);
                        
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    </script>
{% endblock %}