{% extends "layouts/app.twig" %}

{% block body_class %}book-form-page{% endblock %}

{% block title %}
    {% if book.id %}
        Modifier le guide {{ book.title }}
    {% else %}
        Créer un guide d'escalade
    {% endif %}
    - TopoclimbCH
{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/books') }}">Guides</a></li>
            {% if book.id %}
                <li class="breadcrumb-item"><a href="{{ url('/books/' ~ book.id) }}">{{ book.title }}</a></li>
                <li class="breadcrumb-item active">Modifier</li>
            {% else %}
                <li class="breadcrumb-item active">Nouveau guide</li>
            {% endif %}
        </ol>
    </nav>
    
    <h1>
        {% if book.id %}
            Modifier le guide {{ book.title }}
        {% else %}
            Créer un guide d'escalade
        {% endif %}
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <form action="{{ book.id ? url('/books/' ~ book.id) : url('/books') }}" 
              method="post" 
              enctype="multipart/form-data" 
              class="book-form-content" 
              id="book-form"
              data-book-id="{{ book.id|default('') }}"
              autocomplete="on">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if book.id %}
                <input type="hidden" name="_method" value="PUT">
            {% endif %}

            <!-- Informations de base -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations de base</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="title" class="form-label">
                            Titre du guide <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ book.title|default('') }}" 
                               required maxlength="255" 
                               aria-describedby="title-help">
                        <small id="title-help" class="form-text text-muted">
                            Titre complet du guide ou topo d'escalade
                        </small>
                    </div>

                    {% if sites is defined %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="region_id" class="form-label">Région couverte</label>
                                    <select class="form-control" id="region_id" name="region_id" 
                                            aria-describedby="region-help">
                                        <option value="">Toutes les régions</option>
                                        {% if selected_region %}
                                            <option value="{{ selected_region.id }}" selected>{{ selected_region.name }}</option>
                                        {% endif %}
                                    </select>
                                    <small id="region-help" class="form-text text-muted">
                                        Région géographique principale couverte par le guide
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="site_id" class="form-label">Site principal</label>
                                    <select class="form-control" id="site_id" name="site_id" 
                                            aria-describedby="site-help">
                                        <option value="">Tous les sites</option>
                                        {% for site in sites %}
                                            <option value="{{ site.id }}" 
                                                    {{ (selected_site and selected_site.id == site.id) or (book.site_id and book.site_id == site.id) ? 'selected' : '' }}>
                                                {{ site.name }}{% if site.region_name %} ({{ site.region_name }}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small id="site-help" class="form-text text-muted">
                                        Site d'escalade principal couvert par le guide
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description du contenu</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="4" aria-describedby="description-help">{{ book.description|default('') }}</textarea>
                        <small id="description-help" class="form-text text-muted">
                            Description détaillée du contenu et des secteurs couverts
                        </small>
                    </div>
                </div>
            </div>

            <!-- Informations éditoriales -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations éditoriales</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="author" class="form-label">Auteur(s)</label>
                                <input type="text" class="form-control" id="author" name="author" 
                                       value="{{ book.author|default('') }}" 
                                       maxlength="255" 
                                       aria-describedby="author-help">
                                <small id="author-help" class="form-text text-muted">
                                    Nom de l'auteur ou des auteurs du guide
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="publisher" class="form-label">Éditeur</label>
                                <input type="text" class="form-control" id="publisher" name="publisher" 
                                       value="{{ book.publisher|default('') }}" 
                                       maxlength="255" 
                                       aria-describedby="publisher-help">
                                <small id="publisher-help" class="form-text text-muted">
                                    Maison d'édition qui a publié le guide
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="publication_year" class="form-label">Année de publication</label>
                                <input type="number" class="form-control" id="publication_year" name="publication_year" 
                                       value="{{ book.publication_year|default('') }}" 
                                       min="1900" max="{{ "now"|date("Y") }}" 
                                       aria-describedby="year-help">
                                <small id="year-help" class="form-text text-muted">
                                    Année de première publication du guide
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="isbn" name="isbn" 
                                       value="{{ book.isbn|default('') }}" 
                                       maxlength="20" 
                                       aria-describedby="isbn-help">
                                <small id="isbn-help" class="form-text text-muted">
                                    Numéro ISBN pour identification unique
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Caractéristiques -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Caractéristiques</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="pages" class="form-label">Nombre de pages</label>
                                <input type="number" class="form-control" id="pages" name="pages" 
                                       value="{{ book.pages|default('') }}" 
                                       min="1" max="9999" 
                                       aria-describedby="pages-help">
                                <small id="pages-help" class="form-text text-muted">
                                    Nombre total de pages du guide
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="language" class="form-label">Langue</label>
                                <select class="form-control" id="language" name="language" 
                                        aria-describedby="language-help">
                                    <option value="">Sélectionner...</option>
                                    <option value="fr" {% if book.language == 'fr' %}selected{% endif %}>Français</option>
                                    <option value="de" {% if book.language == 'de' %}selected{% endif %}>Allemand</option>
                                    <option value="it" {% if book.language == 'it' %}selected{% endif %}>Italien</option>
                                    <option value="en" {% if book.language == 'en' %}selected{% endif %}>Anglais</option>
                                    <option value="rm" {% if book.language == 'rm' %}selected{% endif %}>Romanche</option>
                                </select>
                                <small id="language-help" class="form-text text-muted">
                                    Langue principale du guide
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="price" class="form-label">Prix</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="price" name="price" 
                                           value="{{ book.price|default('') }}" 
                                           step="0.01" min="0" max="999.99" 
                                           aria-describedby="price-help">
                                    <span class="input-group-text">CHF</span>
                                </div>
                                <small id="price-help" class="form-text text-muted">
                                    Prix de vente du guide (optionnel)
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="url" class="form-label">Site web ou lien</label>
                                <input type="url" class="form-control" id="url" name="url" 
                                       value="{{ book.url|default('') }}" 
                                       maxlength="500" 
                                       aria-describedby="url-help">
                                <small id="url-help" class="form-text text-muted">
                                    Lien vers le site de l'éditeur ou informations complémentaires
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Images</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="image" class="form-label">Ajouter une image</label>
                        <div class="custom-file">
                            <input type="file" name="image" id="image" 
                                   class="custom-file-input" accept="image/*" 
                                   aria-describedby="image-help">
                            <label class="custom-file-label" for="image">Choisir un fichier</label>
                        </div>
                        <small id="image-help" class="form-text text-muted">
                            Image de couverture du guide. Formats supportés: JPG, PNG, GIF. Taille max: 5MB
                        </small>
                    </div>
                </div>
            </div>

            <!-- État -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">État</h3>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" name="active" id="active" class="form-check-input" 
                               value="1" {% if not book or book.active != 0 %}checked{% endif %}>
                        <label for="active" class="form-check-label">
                            Guide actif
                        </label>
                        <small class="form-text text-muted d-block">
                            Décochez pour désactiver temporairement le guide
                        </small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions d-flex gap-3 mb-5">
                <button type="submit" class="btn btn-primary">
                    {% if book.id %}
                        <i class="fa fa-save"></i> Mettre à jour
                    {% else %}
                        <i class="fa fa-plus"></i> Créer le guide
                    {% endif %}
                </button>
                
                <a href="{{ book.id ? url('/books/' ~ book.id) : url('/books') }}" 
                   class="btn btn-secondary">
                    <i class="fa fa-times"></i> Annuler
                </a>
                
                {% if book.id %}
                    <button type="button" class="btn btn-outline-danger ms-auto" 
                            data-bs-toggle="modal" data-bs-target="#deleteBookModal">
                        <i class="fa fa-trash"></i> Supprimer
                    </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Sidebar avec aide -->
    <div class="col-lg-4">
        <div class="help-section card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fa fa-info-circle text-info"></i> Aide
                </h5>
            </div>
            <div class="card-body">
                <div class="help-item mb-3">
                    <h6>Qu'est-ce qu'un guide ?</h6>
                    <p class="small text-muted">
                        Un guide d'escalade (ou topo) est une publication décrivant 
                        les voies d'escalade d'une ou plusieurs régions avec plans 
                        d'accès, croquis et descriptions détaillées.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Types de guides</h6>
                    <p class="small text-muted">
                        <strong>Topo sélectif:</strong> Voies remarquables uniquement<br>
                        <strong>Topo exhaustif:</strong> Toutes les voies répertoriées<br>
                        <strong>Guide de secteur:</strong> Zone géographique précise<br>
                        <strong>Guide de style:</strong> Un type d'escalade spécifique<br>
                        <strong>Guide de difficulté:</strong> Niveau ciblé (débutant, expert)
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Formats et supports</h6>
                    <p class="small text-muted">
                        <strong>Guide papier:</strong> Livre traditionnel<br>
                        <strong>Topo plastifié:</strong> Résistant aux intempéries<br>
                        <strong>Guide numérique:</strong> PDF, application mobile<br>
                        <strong>Guide en ligne:</strong> Site web, base de données
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Informations essentielles</h6>
                    <p class="small text-muted">
                        <strong>Titre:</strong> Nom du guide ou zone couverte<br>
                        <strong>Auteur:</strong> Ouvreur, équipeur, compilateur<br>
                        <strong>Éditeur:</strong> Maison d'édition ou auto-édition<br>
                        <strong>ISBN:</strong> Facilite l'identification et recherche<br>
                        <strong>Description:</strong> Aide les grimpeurs à choisir
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Couverture géographique</h6>
                    <p class="small text-muted">
                        Sélectionnez la région et le site principal pour faciliter 
                        la recherche par zone. Un guide peut couvrir plusieurs sites 
                        d'une même région ou être spécialisé sur un site unique.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Langues en Suisse</h6>
                    <p class="small text-muted">
                        <strong>Français:</strong> Suisse romande (Valais, Vaud, Genève)<br>
                        <strong>Allemand:</strong> Suisse alémanique (majorité du pays)<br>
                        <strong>Italien:</strong> Tessin et Grisons italiens<br>
                        <strong>Romanche:</strong> Grisons (langue régionale)<br>
                        <strong>Anglais:</strong> Guides internationaux, tourisme
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Informations de prix</h6>
                    <p class="small text-muted">
                        Indiquez le prix de vente public pour aider les grimpeurs 
                        dans leur recherche. Prix typiques: 15-25 CHF pour un topo 
                        régional, 35-50 CHF pour un guide exhaustif.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>ISBN et identification</h6>
                    <p class="small text-muted">
                        L'ISBN (International Standard Book Number) est un identifiant 
                        unique international. Format moderne à 13 chiffres: 
                        978-2-1234-5678-9. Facilite les commandes et recherches.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Années de publication</h6>
                    <p class="small text-muted">
                        Indiquez l'année de première publication, pas celle des réimpressions. 
                        Important pour la datation des cotations et équipements décrits.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Liens et ressources</h6>
                    <p class="small text-muted">
                        Ajoutez le site de l'éditeur, boutique en ligne, errata, 
                        ou ressources complémentaires (cartes, conditions, météo).
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Conseils pratiques</h6>
                    <p class="small text-muted">
                        • Vérifiez que le guide n'existe pas déjà dans la base<br>
                        • Ajoutez une description détaillée du contenu<br>
                        • Mentionnez le niveau de difficulté couvert<br>
                        • Indiquez si c'est une réédition mise à jour<br>
                        • Précisez le nombre de voies ou secteurs couverts
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Image de couverture</h6>
                    <p class="small text-muted">
                        Ajoutez une photo de la couverture du guide en bonne qualité. 
                        Évitez les photos floues ou avec des reflets. Format JPG recommandé.
                    </p>
                </div>
                
                <div class="help-item">
                    <h6>Hiérarchie</h6>
                    <p class="small text-muted">
                        <strong>Région</strong> → <strong>Site</strong> → <strong>Secteur</strong> → <strong>Voie</strong><br>
                        <small>Un guide peut couvrir plusieurs niveaux hiérarchiques</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de suppression -->
{% if book.id %}
<div class="modal fade" id="deleteBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer le guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer le guide <strong>{{ book.title }}</strong> ?</p>
                <p class="text-danger small">
                    <i class="fa fa-exclamation-triangle"></i>
                    Cette action est irréversible.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <form method="POST" action="{{ url('/books/' ~ book.id) }}" class="d-inline" autocomplete="on">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        Supprimer définitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- TopoclimbCH JavaScript Components -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('📘 Initialisation gestionnaire de formulaire guide TopoclimbCH');
    
    try {
        // Initialiser le gestionnaire de formulaire
        const formManager = new BookFormManager({
            formId: 'book-form'
        });
        
        console.log('✅ Gestionnaire de formulaire guide initialisé');
        
        // Gestion du fichier image
        const imageInput = document.getElementById('image');
        if (imageInput) {
            imageInput.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (label) {
                    const fileName = this.files[0]?.name || 'Choisir un fichier';
                    label.textContent = fileName;
                }
            });
        }
        
        // Validation en temps réel
        const titleInput = document.getElementById('title');
        if (titleInput) {
            titleInput.addEventListener('input', function() {
                if (this.value.length < 3) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                }
            });
        }
        
        // Écouter les événements personnalisés
        window.TopoclimbCH.Events.on('form:validation-error', function(errors) {
            console.warn('⚠️ Erreurs de validation:', errors);
        });
        
    } catch (error) {
        console.error('❌ Erreur initialisation formulaire guide:', error);
        // Fonctionnalité basique en cas d'erreur
        initBasicFormFunctionality();
    }
});

/**
 * Fonctionnalité de base en cas d'erreur
 */
function initBasicFormFunctionality() {
    console.log('🔄 Initialisation fonctionnalité de base formulaire guide');
    
    // Gestion fichier basique
    const imageInput = document.getElementById('image');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (label) {
                const fileName = this.files[0]?.name || 'Choisir un fichier';
                label.textContent = fileName;
            }
        });
    }
}
</script>

<style>
.form-section .card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-section .card-title {
    color: #495057;
    font-weight: 600;
}

.custom-file-label::after {
    content: "Parcourir";
}

.help-section {
    position: sticky;
    top: 2rem;
}

.help-item h6 {
    color: #495057;
    font-weight: 600;
}

.form-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

/* Validation visuelle */
.is-valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.51.51 1.72-1.72 3.51-3.52-.51-.51-3.51 3.52L2.3 6.73z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right .375rem center;
    background-size: .75rem .75rem;
}

.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right .375rem center;
    background-size: .75rem .75rem;
}

@media (max-width: 768px) {
    .help-section {
        position: static;
        margin-top: 2rem;
    }
}
</style>
{% endblock %}