{% extends "layouts/app.twig" %}

{% block body_class %}book-form-page{% endblock %}

{% block title %}
    {% if book.id %}
        Modifier le guide {{ book.title }}
    {% else %}
        Cr√©er un guide d'escalade
    {% endif %}
    - TopoclimbCH
{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/books') }}">Guides</a></li>
            {% if book.id %}
                <li class="breadcrumb-item"><a href="{{ url('/books/' ~ book.id) }}">{{ book.title }}</a></li>
                <li class="breadcrumb-item active">Modifier</li>
            {% else %}
                <li class="breadcrumb-item active">Nouveau guide</li>
            {% endif %}
        </ol>
    </nav>
    
    <h1>
        {% if book.id %}
            Modifier le guide {{ book.title }}
        {% else %}
            Cr√©er un guide d'escalade
        {% endif %}
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <form action="{{ book.id ? url('/books/' ~ book.id) : url('/books') }}" 
              method="post" 
              enctype="multipart/form-data" 
              class="book-form-content" 
              id="book-form"
              data-book-id="{{ book.id|default('') }}"
              autocomplete="on">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if book.id %}
                <input type="hidden" name="_method" value="PUT">
            {% endif %}

            <!-- Informations de base -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations de base</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="title" class="form-label">
                            Titre du guide <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ book.title|default('') }}" 
                               required maxlength="255" 
                               aria-describedby="title-help">
                        <small id="title-help" class="form-text text-muted">
                            Titre complet du guide ou topo d'escalade
                        </small>
                    </div>

                    {% if sites is defined %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="region_id" class="form-label">R√©gion couverte</label>
                                    <select class="form-control" id="region_id" name="region_id" 
                                            aria-describedby="region-help">
                                        <option value="">Toutes les r√©gions</option>
                                        {% if selected_region %}
                                            <option value="{{ selected_region.id }}" selected>{{ selected_region.name }}</option>
                                        {% endif %}
                                    </select>
                                    <small id="region-help" class="form-text text-muted">
                                        R√©gion g√©ographique principale couverte par le guide
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="site_id" class="form-label">Site principal</label>
                                    <select class="form-control" id="site_id" name="site_id" 
                                            aria-describedby="site-help">
                                        <option value="">Tous les sites</option>
                                        {% for site in sites %}
                                            <option value="{{ site.id }}" 
                                                    {{ (selected_site and selected_site.id == site.id) or (book.site_id and book.site_id == site.id) ? 'selected' : '' }}>
                                                {{ site.name }}{% if site.region_name %} ({{ site.region_name }}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small id="site-help" class="form-text text-muted">
                                        Site d'escalade principal couvert par le guide
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Informations √©ditoriales -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations √©ditoriales</h3>
                </div>
                <div class="card-body">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="author" class="form-label">Auteur(s)</label>
                                <input type="text" class="form-control" id="author" name="author" 
                                       value="{{ book.author|default('') }}" 
                                       maxlength="255" 
                                       aria-describedby="author-help">
                                <small id="author-help" class="form-text text-muted">
                                    Nom de l'auteur ou des auteurs du guide
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="publisher" class="form-label">√âditeur</label>
                                <input type="text" class="form-control" id="publisher" name="publisher" 
                                       value="{{ book.publisher|default('') }}" 
                                       maxlength="255" 
                                       aria-describedby="publisher-help">
                                <small id="publisher-help" class="form-text text-muted">
                                    Maison d'√©dition qui a publi√© le guide
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="publication_year" class="form-label">Ann√©e de publication</label>
                                <input type="number" class="form-control" id="publication_year" name="publication_year" min="1900" max="{{ "now"|date("Y") }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="isbn" name="isbn">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                        <div class="form-text">Description du contenu du guide</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pages" class="form-label">Nombre de pages</label>
                                <input type="number" class="form-control" id="pages" name="pages" min="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="language" class="form-label">Langue</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="">S√©lectionner...</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Allemand</option>
                                    <option value="it">Italien</option>
                                    <option value="en">Anglais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="url" class="form-label">Site web ou lien</label>
                        <input type="url" class="form-control" id="url" name="url">
                        <div class="form-text">Lien vers le site de l'√©diteur ou des informations compl√©mentaires</div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url('/books') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Retour
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Cr√©er le guide
                        </button>
                    </div>
                </div>
            </form>
        </div>

    <!-- Sidebar avec aide -->
    <div class="col-lg-4">
        <div class="help-section card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fa fa-info-circle text-info"></i> Aide
                </h5>
            </div>
            <div class="card-body">
                <div class="help-item mb-3">
                    <h6>Qu'est-ce qu'un guide ?</h6>
                    <p class="small text-muted">
                        Un guide d'escalade (ou topo) est une publication d√©crivant 
                        les voies d'escalade d'une ou plusieurs r√©gions avec plans 
                        d'acc√®s, croquis et descriptions d√©taill√©es.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Types de guides</h6>
                    <p class="small text-muted">
                        <strong>Topo s√©lectif:</strong> Voies remarquables<br>
                        <strong>Topo exhaustif:</strong> Toutes les voies connues<br>
                        <strong>Guide de secteur:</strong> Zone g√©ographique pr√©cise<br>
                        <strong>Guide de style:</strong> Un type d'escalade sp√©cifique
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Informations essentielles</h6>
                    <p class="small text-muted">
                        Titre, auteur et ann√©e sont les informations minimales.
                        L'ISBN facilite l'identification et la recherche.
                        La description aide les grimpeurs √† choisir.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Localisation</h6>
                    <p class="small text-muted">
                        S√©lectionnez la r√©gion et le site principal couverts 
                        pour faciliter la recherche par zone g√©ographique.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Langues en Suisse</h6>
                    <p class="small text-muted">
                        <strong>Fran√ßais:</strong> Suisse romande<br>
                        <strong>Allemand:</strong> Suisse al√©manique<br>
                        <strong>Italien:</strong> Tessin<br>
                        <strong>Romanche:</strong> Grisons<br>
                        <strong>Anglais:</strong> Guides internationaux
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Conseils pratiques</h6>
                    <p class="small text-muted">
                        ‚Ä¢ V√©rifiez que le guide n'existe pas d√©j√†<br>
                        ‚Ä¢ Ajoutez une description d√©taill√©e<br>
                        ‚Ä¢ Mentionnez le niveau de difficult√© couvert<br>
                        ‚Ä¢ Indiquez si c'est une r√©√©dition mise √† jour
                    </p>
                </div>
                
                <div class="help-item">
                    <h6>Hi√©rarchie</h6>
                    <p class="small text-muted">
                        <strong>R√©gion</strong> ‚Üí <strong>Site</strong> ‚Üí <strong>Secteur</strong> ‚Üí <strong>Voie</strong><br>
                        <small>Un guide peut couvrir plusieurs niveaux</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Modal de suppression -->
{% if book.id %}
<div class="modal fade" id="deleteBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer le guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir supprimer le guide <strong>{{ book.title }}</strong> ?</p>
                <p class="text-danger small">
                    <i class="fa fa-exclamation-triangle"></i>
                    Cette action est irr√©versible.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <form method="POST" action="{{ url('/books/' ~ book.id) }}" class="d-inline" autocomplete="on">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        Supprimer d√©finitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- TopoclimbCH JavaScript Components -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìò Initialisation gestionnaire de formulaire guide TopoclimbCH');
    
    try {
        // Initialiser le gestionnaire de formulaire
        const formManager = new BookFormManager({
            formId: 'book-form'
        });
        
        console.log('‚úÖ Gestionnaire de formulaire guide initialis√©');
        
        // Gestion du fichier image
        const imageInput = document.getElementById('image');
        if (imageInput) {
            imageInput.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (label) {
                    const fileName = this.files[0]?.name || 'Choisir un fichier';
                    label.textContent = fileName;
                }
            });
        }
        
        // Validation en temps r√©el
        const titleInput = document.getElementById('title');
        if (titleInput) {
            titleInput.addEventListener('input', function() {
                if (this.value.length < 3) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else {
                    this.classList.add('is-valid');
                    this.classList.remove('is-invalid');
                }
            });
        }
        
        // √âcouter les √©v√©nements personnalis√©s
        window.TopoclimbCH.Events.on('form:validation-error', function(errors) {
            console.warn('‚ö†Ô∏è Erreurs de validation:', errors);
        });
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation formulaire guide:', error);
        // Fonctionnalit√© basique en cas d'erreur
        initBasicFormFunctionality();
    }
});

/**
 * Fonctionnalit√© de base en cas d'erreur
 */
function initBasicFormFunctionality() {
    console.log('üîÑ Initialisation fonctionnalit√© de base formulaire guide');
    
    // Gestion fichier basique
    const imageInput = document.getElementById('image');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (label) {
                const fileName = this.files[0]?.name || 'Choisir un fichier';
                label.textContent = fileName;
            }
        });
    }
}
</script>

<style>
.form-section .card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-section .card-title {
    color: #495057;
    font-weight: 600;
}

.custom-file-label::after {
    content: "Parcourir";
}

.help-section {
    position: sticky;
    top: 2rem;
}

.help-item h6 {
    color: #495057;
    font-weight: 600;
}

.form-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

/* Validation visuelle */
.is-valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.51.51 1.72-1.72 3.51-3.52-.51-.51-3.51 3.52L2.3 6.73z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right .375rem center;
    background-size: .75rem .75rem;
}

.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right .375rem center;
    background-size: .75rem .75rem;
}

@media (max-width: 768px) {
    .help-section {
        position: static;
        margin-top: 2rem;
    }
}
</style>
{% endblock %}