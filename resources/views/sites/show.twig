{% extends "layouts/app.twig" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="site-show">
    <div class="container">
        
        <!-- En-tête avec breadcrumb -->
        <div class="page-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="/regions">Régions</a></li>
                    <li class="breadcrumb-item"><a href="/regions/{{ region.id }}">{{ region.name }}</a></li>
                    <li class="breadcrumb-item"><a href="/sites?region_id={{ region.id }}">Sites</a></li>
                    <li class="breadcrumb-item active">{{ site.name }}</li>
                </ol>
            </nav>
            
            <div class="site-header">
                <div class="site-title">
                    <h1>{{ site.name }}</h1>
                    <div class="site-code">{{ site.code|upper }}</div>
                </div>
                
                <div class="site-actions">
                    <a href="/sites/{{ site.id }}/edit" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Modifier
                    </a>
                    <a href="/sectors/create?site_id={{ site.id }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Nouveau secteur
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/sites/selector?preselected=site:{{ site.id }}">
                                <i class="fas fa-search"></i> Sélecteur hiérarchique
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="window.print()">
                                <i class="fas fa-print"></i> Imprimer
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete()">
                                <i class="fas fa-trash"></i> Supprimer
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations principales -->
        <div class="site-info">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Description -->
                    {% if site.description %}
                    <div class="info-section">
                        <h3>Description</h3>
                        <div class="description-content">
                            {{ site.description|nl2br }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Statistiques détaillées -->
                    <div class="info-section">
                        <h3>Statistiques</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-climbing"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number">{{ sectors|length }}</div>
                                    <div class="stat-label">Secteur{{ sectors|length > 1 ? 's' : '' }}</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number">{{ totalRoutes }}</div>
                                    <div class="stat-label">Voie{{ totalRoutes > 1 ? 's' : '' }}</div>
                                </div>
                            </div>
                            {% if avgDifficulty %}
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number">{{ avgDifficulty }}</div>
                                    <div class="stat-label">Difficulté moy.</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Secteurs du site -->
                    <div class="info-section">
                        <h3>Secteurs de ce site</h3>
                        
                        {% if sectors is empty %}
                        <div class="empty-state">
                            <i class="fas fa-climbing"></i>
                            <p>Aucun secteur dans ce site</p>
                            <a href="/sectors/create?site_id={{ site.id }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Créer le premier secteur
                            </a>
                        </div>
                        {% else %}
                        <div class="sectors-list">
                            {% for sector in sectors %}
                            <div class="sector-card">
                                <div class="sector-header">
                                    <h4>
                                        <a href="/sectors/{{ sector.id }}">{{ sector.name }}</a>
                                    </h4>
                                    <div class="sector-stats">
                                        <span class="badge badge-primary">{{ sector.route_count }} voies</span>
                                        {% if sector.avg_beauty %}
                                        <span class="badge badge-warning">
                                            ★ {{ sector.avg_beauty|number_format(1) }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if sector.description %}
                                <p class="sector-description">{{ sector.description|truncate(100) }}</p>
                                {% endif %}
                                
                                <div class="sector-details">
                                    {% if sector.min_difficulty and sector.max_difficulty %}
                                    <span class="detail-item">
                                        <i class="fas fa-chart-line"></i>
                                        {{ sector.min_difficulty }} - {{ sector.max_difficulty }}
                                    </span>
                                    {% endif %}
                                    {% if sector.altitude %}
                                    <span class="detail-item">
                                        <i class="fas fa-mountain"></i>
                                        {{ sector.altitude }}m
                                    </span>
                                    {% endif %}
                                    {% if sector.access_time %}
                                    <span class="detail-item">
                                        <i class="fas fa-clock"></i>
                                        {{ sector.access_time }}min
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <div class="sector-actions">
                                    <a href="/sectors/{{ sector.id }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i> Voir
                                    </a>
                                    <a href="/sectors/{{ sector.id }}/edit" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i> Modifier
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                </div>

                <div class="col-lg-4">
                    <!-- Métadonnées -->
                    <div class="sidebar-section">
                        <h4>Informations</h4>
                        <div class="meta-list">
                            <div class="meta-item">
                                <strong>Région :</strong>
                                <a href="/regions/{{ region.id }}">{{ region.name }}</a>
                            </div>
                            <div class="meta-item">
                                <strong>Code :</strong>
                                {{ site.code|upper }}
                            </div>
                            {% if site.year %}
                            <div class="meta-item">
                                <strong>Année :</strong>
                                {{ site.year }}
                            </div>
                            {% endif %}
                            {% if site.publisher %}
                            <div class="meta-item">
                                <strong>Éditeur :</strong>
                                {{ site.publisher }}
                            </div>
                            {% endif %}
                            {% if site.isbn %}
                            <div class="meta-item">
                                <strong>ISBN :</strong>
                                {{ site.isbn }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="sidebar-section">
                        <h4>Actions rapides</h4>
                        <div class="quick-actions">
                            <a href="/sites/selector?mode=book&site_id={{ site.id }}" class="action-link">
                                <i class="fas fa-book"></i>
                                <div>
                                    <strong>Gestion topo</strong>
                                    <small>Sélectionner secteurs/voies pour un livre</small>
                                </div>
                            </a>
                            <a href="/sites/selector?mode=stats&site_id={{ site.id }}" class="action-link">
                                <i class="fas fa-chart-bar"></i>
                                <div>
                                    <strong>Statistiques détaillées</strong>
                                    <small>Analyser les données du site</small>
                                </div>
                            </a>
                            <a href="/sectors?site_id={{ site.id }}" class="action-link">
                                <i class="fas fa-list"></i>
                                <div>
                                    <strong>Liste des secteurs</strong>
                                    <small>Vue détaillée avec filtres</small>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Navigation hiérarchique -->
                    <div class="sidebar-section">
                        <h4>Navigation</h4>
                        <div class="hierarchy-nav">
                            <a href="/regions" class="nav-item">
                                <i class="fas fa-mountain"></i>
                                <span>Toutes les régions</span>
                            </a>
                            <a href="/regions/{{ region.id }}" class="nav-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ region.name }}</span>
                            </a>
                            <a href="/sites?region_id={{ region.id }}" class="nav-item">
                                <i class="fas fa-layer-group"></i>
                                <span>Sites de {{ region.name }}</span>
                            </a>
                            <div class="nav-item active">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ site.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer le site <strong>{{ site.name }}</strong> ?</p>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Cette action ne peut pas être annulée. Tous les secteurs de ce site seront déplacés directement dans la région.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form method="POST" action="/sites/{{ site.id }}/delete" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrfToken }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/css/pages/sites/show.css">
{% endblock %}

{% block scripts %}
<script src="/js/pages/sites/show.js"></script>
<script>
function confirmDelete() {
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}
</script>
{% endblock %}