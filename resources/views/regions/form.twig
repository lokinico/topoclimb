{% extends "layouts/app.twig" %}

{% block body_class %}region-form-page{% endblock %}

{% block title %}
    {% if region.id %}
        Modifier la r√©gion {{ region.name }}
    {% else %}
        Cr√©er une r√©gion
    {% endif %}
    - TopoclimbCH
{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/regions') }}">R√©gions</a></li>
            {% if region.id %}
                <li class="breadcrumb-item"><a href="{{ url('/regions/' ~ region.id) }}">{{ region.name }}</a></li>
                <li class="breadcrumb-item active">Modifier</li>
            {% else %}
                <li class="breadcrumb-item active">Nouvelle r√©gion</li>
            {% endif %}
        </ol>
    </nav>
    
    <h1>
        {% if region.id %}
            Modifier la r√©gion {{ region.name }}
        {% else %}
            Cr√©er une nouvelle r√©gion
        {% endif %}
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <form action="{{ region.id ? url('/regions/' ~ region.id) : url('/regions') }}" 
              method="post" 
              enctype="multipart/form-data" 
              class="region-form-content" 
              id="region-form"
              data-region-id="{{ region.id|default('') }}"
              autocomplete="off">
            
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if region.id %}
                <input type="hidden" name="_method" value="PUT">
            {% endif %}

            <!-- Informations de base -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations de base</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="name" class="form-label">
                            Nom de la r√©gion <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ region.name|default('') }}" 
                               required maxlength="255" 
                               aria-describedby="name-help">
                        <small id="name-help" class="form-text text-muted">
                            Nom complet de la r√©gion d'escalade
                        </small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="country_id" class="form-label">
                            Pays <span class="text-danger">*</span>
                        </label>
                        <select class="form-control" id="country_id" name="country_id" required aria-describedby="country-help">
                            <option value="">S√©lectionnez un pays...</option>
                            {% for country in countries %}
                                <option value="{{ country.id }}" 
                                        {{ ((region.country_id and region.country_id == country.id) or (not region.id and country.code == 'CH')) ? 'selected' : '' }}>
                                    {{ country.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <small id="country-help" class="form-text text-muted">
                            Pays auquel appartient la r√©gion
                        </small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="4" aria-describedby="description-help">{{ region.description|default('') }}</textarea>
                        <small id="description-help" class="form-text text-muted">
                            Description g√©n√©rale de la r√©gion d'escalade
                        </small>
                    </div>
                </div>
            </div>

            <!-- Caract√©ristiques -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Caract√©ristiques</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="altitude" class="form-label">Altitude moyenne</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="altitude" name="altitude" 
                                           value="{{ region.altitude|default('') }}" 
                                           min="0" max="5000" 
                                           aria-describedby="altitude-help">
                                    <span class="input-group-text">m</span>
                                </div>
                                <small id="altitude-help" class="form-text text-muted">
                                    Altitude moyenne de la r√©gion en m√®tres
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="best_season" class="form-label">Meilleure saison</label>
                                <select class="form-control" id="best_season" name="best_season" 
                                        aria-describedby="season-help">
                                    <option value="">Non sp√©cifi√©e</option>
                                    <option value="spring" {% if region.best_season == 'spring' %}selected{% endif %}>Printemps</option>
                                    <option value="summer" {% if region.best_season == 'summer' %}selected{% endif %}>√ât√©</option>
                                    <option value="autumn" {% if region.best_season == 'autumn' %}selected{% endif %}>Automne</option>
                                    <option value="winter" {% if region.best_season == 'winter' %}selected{% endif %}>Hiver</option>
                                    <option value="year-round" {% if region.best_season == 'year-round' %}selected{% endif %}>Toute l'ann√©e</option>
                                </select>
                                <small id="season-help" class="form-text text-muted">
                                    P√©riode optimale pour l'escalade
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Localisation -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Localisation</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_lat" class="form-label">Latitude</label>
                                <input type="number" name="coordinates_lat" id="coordinates_lat" 
                                       class="form-control" 
                                       value="{{ region.coordinates_lat|default('') }}" 
                                       step="0.00000001" min="-90" max="90"
                                       aria-describedby="lat-help">
                                <small id="lat-help" class="form-text text-muted">
                                    Latitude en degr√©s d√©cimaux (ex: 46.2044)
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_lng" class="form-label">Longitude</label>
                                <input type="number" name="coordinates_lng" id="coordinates_lng" 
                                       class="form-control" 
                                       value="{{ region.coordinates_lng|default('') }}" 
                                       step="0.00000001" min="-180" max="180"
                                       aria-describedby="lng-help">
                                <small id="lng-help" class="form-text text-muted">
                                    Longitude en degr√©s d√©cimaux (ex: 6.1432)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_swiss_e" class="form-label">Coordonn√©es suisses E (LV95)</label>
                                <div class="input-group">
                                    <input type="text" name="coordinates_swiss_e" id="coordinates_swiss_e" 
                                           class="form-control" 
                                           value="{{ region.coordinates_swiss_e|default('') }}" 
                                           aria-describedby="ch-e-help"
                                           placeholder="2600000">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                id="convert-to-gps-btn" 
                                                title="Convertir LV95 ‚Üí GPS">
                                            <i class="fa fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <small id="ch-e-help" class="form-text text-muted">
                                    Coordonn√©e Est du syst√®me suisse LV95
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="coordinates_swiss_n" class="form-label">Coordonn√©es suisses N (LV95)</label>
                                <div class="input-group">
                                    <input type="text" name="coordinates_swiss_n" id="coordinates_swiss_n" 
                                           class="form-control" 
                                           value="{{ region.coordinates_swiss_n|default('') }}" 
                                           aria-describedby="ch-n-help"
                                           placeholder="1200000">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                id="convert-to-lv95-btn" 
                                                title="Convertir GPS ‚Üí LV95">
                                            <i class="fa fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <small id="ch-n-help" class="form-text text-muted">
                                    Coordonn√©e Nord du syst√®me suisse LV95
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="coordinate-conversion-help mb-3">
                        <div class="alert alert-info">
                            <strong><i class="fa fa-info-circle"></i> Conversion de coordonn√©es:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Utilisez <i class="fa fa-exchange-alt"></i> pour convertir entre GPS et LV95</li>
                                <li>Les coordonn√©es GPS sont utilis√©es pour l'affichage sur cartes</li>
                                <li>Les coordonn√©es LV95 sont le syst√®me officiel suisse</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Carte interactive -->
                    <div class="map-section">
                        <label class="form-label">S√©lectionner la position sur la carte</label>
                        <div id="region-map" 
                             data-coordinates-lat="{{ region.coordinates_lat|default('') }}" 
                             data-coordinates-lng="{{ region.coordinates_lng|default('') }}"
                             style="height: 350px; border-radius: 0.375rem; border: 1px solid #dee2e6;"></div>
                        <small class="form-text text-muted mt-2">
                            Cliquez sur la carte pour placer le centre approximatif de la r√©gion
                        </small>
                    </div>
                </div>
            </div>

            <!-- Acc√®s -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Informations d'acc√®s</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="access_info" class="form-label">Informations d'acc√®s</label>
                        <textarea class="form-control" id="access_info" name="access_info" 
                                  rows="4" aria-describedby="access-help">{{ region.access_info|default('') }}</textarea>
                        <small id="access-help" class="form-text text-muted">
                            Instructions g√©n√©rales pour acc√©der √† la r√©gion
                        </small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="parking_info" class="form-label">Informations de parking</label>
                        <textarea class="form-control" id="parking_info" name="parking_info" 
                                  rows="3" aria-describedby="parking-help">{{ region.parking_info|default('') }}</textarea>
                        <small id="parking-help" class="form-text text-muted">
                            Informations sur les parkings principaux disponibles
                        </small>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Images</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="cover_image" class="form-label">Image de couverture</label>
                        <div class="custom-file">
                            <input type="file" name="cover_image" id="cover_image" 
                                   class="custom-file-input" accept="image/*" 
                                   aria-describedby="cover-help">
                            <label class="custom-file-label" for="cover_image">Choisir un fichier</label>
                        </div>
                        <small id="cover-help" class="form-text text-muted">
                            Image principale repr√©sentant la r√©gion. Formats support√©s: JPG, PNG, GIF. Taille max: 5MB
                        </small>
                    </div>
                </div>
            </div>

            <!-- √âtat -->
            <div class="form-section card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">√âtat</h3>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" name="active" id="active" class="form-check-input" 
                               value="1" {% if not region or region.active != 0 %}checked{% endif %}>
                        <label for="active" class="form-check-label">
                            R√©gion active
                        </label>
                        <small class="form-text text-muted d-block">
                            D√©cochez pour d√©sactiver temporairement la r√©gion
                        </small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions d-flex gap-3 mb-5">
                <button type="submit" class="btn btn-primary">
                    {% if region.id %}
                        <i class="fa fa-save"></i> Mettre √† jour
                    {% else %}
                        <i class="fa fa-plus"></i> Cr√©er la r√©gion
                    {% endif %}
                </button>
                
                <a href="{{ region.id ? url('/regions/' ~ region.id) : url('/regions') }}" 
                   class="btn btn-secondary">
                    <i class="fa fa-times"></i> Annuler
                </a>
                
                {% if region.id %}
                    <button type="button" class="btn btn-outline-danger ms-auto" 
                            data-bs-toggle="modal" data-bs-target="#deleteRegionModal">
                        <i class="fa fa-trash"></i> Supprimer
                    </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Sidebar avec aide -->
    <div class="col-lg-4">
        <div class="help-section card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fa fa-info-circle text-info"></i> Aide
                </h5>
            </div>
            <div class="card-body">
                <div class="help-item mb-3">
                    <h6>Qu'est-ce qu'une r√©gion ?</h6>
                    <p class="small text-muted">
                        Une r√©gion repr√©sente une zone g√©ographique administrative ou 
                        naturelle qui regroupe plusieurs sites d'escalade (ex: Valais, 
                        Grisons, Province de Li√®ge).
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>R√©gions en Suisse</h6>
                    <p class="small text-muted">
                        <strong>Valais:</strong> Chamonix, Martigny, Arolla<br>
                        <strong>Grisons:</strong> Engadine, Davos, Chur<br>
                        <strong>Tessin:</strong> Valle Verzasca, Mendrisio<br>
                        <strong>Berne:</strong> Oberland, Jura bernois<br>
                        <strong>Vaud:</strong> Alpes vaudoises, Jura vaudois
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>D√©limitation g√©ographique</h6>
                    <p class="small text-muted">
                        D√©finissez les fronti√®res naturelles ou administratives. 
                        Une r√©gion peut suivre les limites cantonales, des massifs 
                        montagneux ou des vall√©es principales.
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Coordonn√©es de r√©f√©rence</h6>
                    <p class="small text-muted">
                        Placez le point au centre g√©ographique approximatif de la r√©gion. 
                        Cette position sert de r√©f√©rence pour l'affichage cartographique 
                        et la recherche g√©ographique.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Saisons d'escalade</h6>
                    <p class="small text-muted">
                        <strong>Printemps:</strong> Mars-Mai (basse altitude)<br>
                        <strong>√ât√©:</strong> Juin-Ao√ªt (haute altitude)<br>
                        <strong>Automne:</strong> Septembre-Novembre<br>
                        <strong>Hiver:</strong> D√©cembre-F√©vrier (sud, abris)<br>
                        <strong>Toute l'ann√©e:</strong> Grottes, surplombs
                    </p>
                </div>
                
                <div class="help-item mb-3">
                    <h6>Altitude et climat</h6>
                    <p class="small text-muted">
                        L'altitude influence directement les conditions d'escalade. 
                        En dessous de 1000m: escalade possible toute l'ann√©e. 
                        Au-dessus de 2000m: saison limit√©e √† l'√©t√©.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Acc√®s g√©n√©ral</h6>
                    <p class="small text-muted">
                        D√©crivez les voies d'acc√®s principales (autoroutes, routes cantonales), 
                        transports publics disponibles, restrictions √©ventuelles 
                        (horaires, p√©ages, autorisations).
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Parking r√©gional</h6>
                    <p class="small text-muted">
                        Mentionnez les parkings principaux de la r√©gion, leur capacit√©, 
                        les tarifs √©ventuels, les restrictions saisonni√®res 
                        et les alternatives en cas de saturation.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Image de couverture</h6>
                    <p class="small text-muted">
                        Choisissez une photo panoramique repr√©sentative du paysage 
                        et du style d'escalade de la r√©gion. √âvitez les gros plans 
                        et privil√©giez les vues d'ensemble.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Classification hi√©rarchique</h6>
                    <p class="small text-muted">
                        <strong>Pays</strong> ‚Üí <strong>R√©gion</strong> ‚Üí <strong>Site</strong> ‚Üí <strong>Secteur</strong> ‚Üí <strong>Voie</strong><br>
                        Une r√©gion regroupe plusieurs sites d'escalade.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>R√©gions transfrontali√®res</h6>
                    <p class="small text-muted">
                        Certaines r√©gions s'√©tendent sur plusieurs pays 
                        (ex: Mont-Blanc, Dolomites). Choisissez le pays principal 
                        et pr√©cisez l'extension dans la description.
                    </p>
                </div>

                <div class="help-item mb-3">
                    <h6>Conseils de nommage</h6>
                    <p class="small text-muted">
                        Utilisez les noms officiels ou largement reconnus. 
                        √âvitez les abr√©viations et privil√©giez la langue locale 
                        dominante. Ex: "Valais" plut√¥t que "VS".
                    </p>
                </div>
                
                <div class="help-item">
                    <h6>Hi√©rarchie</h6>
                    <p class="small text-muted">
                        <strong>R√©gion</strong> ‚Üí <strong>Site</strong> ‚Üí <strong>Secteur</strong> ‚Üí <strong>Voie</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de suppression -->
{% if region.id %}
<div class="modal fade" id="deleteRegionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer la r√©gion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir supprimer la r√©gion <strong>{{ region.name }}</strong> ?</p>
                <p class="text-danger small">
                    <i class="fa fa-exclamation-triangle"></i>
                    Cette action est irr√©versible et supprimera √©galement tous les sites, secteurs et voies associ√©s.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <form method="POST" action="{{ url('/regions/' ~ region.id) }}" class="d-inline" autocomplete="on">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        Supprimer d√©finitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Leaflet pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- TopoclimbCH JavaScript Components -->
<script src="/js/coordinate-converter.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Initialisation gestionnaire de formulaire r√©gion TopoclimbCH');
    
    try {
        // Initialiser le gestionnaire de formulaire avec coordonn√©es existantes
        const formManager = new RegionFormManager({
            mapId: 'region-map',
            latInputId: 'coordinates_lat',
            lngInputId: 'coordinates_lng'
        });
        
        console.log('‚úÖ Gestionnaire de formulaire r√©gion initialis√©');
        
        // Si coordonn√©es existantes dans le formulaire, les utiliser
        {% if region.coordinates_lat and region.coordinates_lng %}
            console.log('üìç Coordonn√©es existantes d√©tect√©es: {{ region.coordinates_lat }}, {{ region.coordinates_lng }}');
        {% endif %}
        
        // Gestion conversion coordonn√©es
        const convertToGpsBtn = document.getElementById('convert-to-gps-btn');
        const convertToLv95Btn = document.getElementById('convert-to-lv95-btn');
        
        if (convertToGpsBtn) {
            convertToGpsBtn.addEventListener('click', async function() {
                await convertLV95toGPS();
            });
        }
        
        if (convertToLv95Btn) {
            convertToLv95Btn.addEventListener('click', async function() {
                await convertGPStoLV95();
            });
        }
        
        // √âcouter les √©v√©nements personnalis√©s
        window.TopoclimbCH.Events.on('form:validation-error', function(errors) {
            console.warn('‚ö†Ô∏è Erreurs de validation:', errors);
        });
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation formulaire r√©gion:', error);
        
        // Fallback vers fonctionnalit√© basique si erreur
        initBasicFormFunctionality();
    }
});

/**
 * Fonctionnalit√© de base en cas d'erreur avec les composants avanc√©s
 */
function initBasicFormFunctionality() {
    console.log('üîÑ Initialisation fonctionnalit√© de base formulaire r√©gion');
    
    // Gestion fichier basique
    const coverImageInput = document.getElementById('cover_image');
    if (coverImageInput) {
        coverImageInput.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (label) {
                const fileName = this.files[0]?.name || 'Choisir un fichier';
                label.textContent = fileName;
            }
        });
    }
    
    // Validation basique des coordonn√©es
    const latInput = document.getElementById('coordinates_lat');
    const lngInput = document.getElementById('coordinates_lng');
    
    if (latInput && lngInput) {
        [latInput, lngInput].forEach(input => {
            input.addEventListener('input', function() {
                const value = parseFloat(this.value);
                const isLat = this.id.includes('lat');
                const min = isLat ? -90 : -180;
                const max = isLat ? 90 : 180;
                
                if (value < min || value > max) {
                    this.classList.add('coordinates-invalid');
                    this.classList.remove('coordinates-valid');
                } else {
                    this.classList.add('coordinates-valid');
                    this.classList.remove('coordinates-invalid');
                }
            });
        });
    }
}

/**
 * Convertit les coordonn√©es LV95 vers GPS
 */
async function convertLV95toGPS() {
    const eastingInput = document.getElementById('coordinates_swiss_e');
    const northingInput = document.getElementById('coordinates_swiss_n');
    const latInput = document.getElementById('coordinates_lat');
    const lngInput = document.getElementById('coordinates_lng');
    
    if (!eastingInput || !northingInput || !latInput || !lngInput) {
        console.error('‚ùå Champs de coordonn√©es non trouv√©s');
        return;
    }
    
    const easting = parseFloat(eastingInput.value);
    const northing = parseFloat(northingInput.value);
    
    if (isNaN(easting) || isNaN(northing)) {
        showNotification('Veuillez saisir des coordonn√©es LV95 valides', 'warning');
        return;
    }
    
    try {
        showNotification('Conversion LV95 ‚Üí GPS en cours...', 'info');
        
        const result = await window.TopoclimbCoordinateConverter.convertLV95toWGS84(easting, northing);
        
        // Mettre √† jour les champs GPS
        latInput.value = result.latitude.toFixed(8);
        lngInput.value = result.longitude.toFixed(8);
        
        // Validation visuelle
        latInput.classList.add('coordinates-valid');
        lngInput.classList.add('coordinates-valid');
        
        showNotification('‚úÖ Conversion LV95 ‚Üí GPS r√©ussie!', 'success');
        
        // Mettre √† jour la carte si elle existe
        if (typeof formManager !== 'undefined' && formManager.updateMapFromCoordinates) {
            formManager.updateMapFromCoordinates(result.latitude, result.longitude);
        }
        
    } catch (error) {
        console.error('‚ùå Erreur conversion LV95‚ÜíGPS:', error);
        showNotification(`Erreur conversion: ${error.message}`, 'error');
    }
}

/**
 * Convertit les coordonn√©es GPS vers LV95
 */
async function convertGPStoLV95() {
    const latInput = document.getElementById('coordinates_lat');
    const lngInput = document.getElementById('coordinates_lng');
    const eastingInput = document.getElementById('coordinates_swiss_e');
    const northingInput = document.getElementById('coordinates_swiss_n');
    
    if (!latInput || !lngInput || !eastingInput || !northingInput) {
        console.error('‚ùå Champs de coordonn√©es non trouv√©s');
        return;
    }
    
    const latitude = parseFloat(latInput.value);
    const longitude = parseFloat(lngInput.value);
    
    if (isNaN(latitude) || isNaN(longitude)) {
        showNotification('Veuillez saisir des coordonn√©es GPS valides', 'warning');
        return;
    }
    
    try {
        showNotification('Conversion GPS ‚Üí LV95 en cours...', 'info');
        
        const result = await window.TopoclimbCoordinateConverter.convertWGS84toLV95(longitude, latitude);
        
        // Mettre √† jour les champs LV95
        eastingInput.value = Math.round(result.easting).toString();
        northingInput.value = Math.round(result.northing).toString();
        
        // Validation visuelle
        eastingInput.classList.add('coordinates-valid');
        northingInput.classList.add('coordinates-valid');
        
        showNotification('‚úÖ Conversion GPS ‚Üí LV95 r√©ussie!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erreur conversion GPS‚ÜíLV95:', error);
        showNotification(`Erreur conversion: ${error.message}`, 'error');
    }
}

/**
 * Affiche une notification √† l'utilisateur
 */
function showNotification(message, type = 'info') {
    // Utiliser les notifications TopoclimbCH si disponibles
    if (typeof TopoclimbCH !== 'undefined' && TopoclimbCH.Notifications) {
        TopoclimbCH.Notifications[type](message);
    } else {
        // Fallback vers alert
        alert(message);
    }
}
</script>

<style>
.form-section .card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-section .card-title {
    color: #495057;
    font-weight: 600;
}

.custom-file-label::after {
    content: "Parcourir";
}

.help-section {
    position: sticky;
    top: 2rem;
}

.help-item h6 {
    color: #495057;
    font-weight: 600;
}

.form-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

/* Styles pour carte dans formulaire */
#region-map {
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    transition: border-color 0.2s;
}

#region-map:hover {
    border-color: #007bff;
}

/* Validation visuelle pour coordonn√©es */
.coordinates-valid {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.coordinates-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

@media (max-width: 768px) {
    .help-section {
        position: static;
        margin-top: 2rem;
    }
    
    #region-map {
        height: 250px !important;
    }
}
</style>
{% endblock %}