<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conversion Coordonnées GPS ↔ LV95 - TopoclimbCH</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .coordinate-section {
            border: 2px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .coordinate-section.valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .coordinate-section.invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .test-result {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .coordinates-display {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="mb-4">
                    <i class="fa fa-map-location-dot text-primary"></i>
                    Test Conversion Coordonnées GPS ↔ LV95
                </h1>
                
                <div class="alert alert-info">
                    <strong><i class="fa fa-info-circle"></i> Test API Swisstopo</strong><br>
                    Cette page permet de tester la conversion entre les coordonnées GPS (WGS84) et LV95 (système suisse)
                    en utilisant l'API officielle Swisstopo.
                </div>

                <!-- Section GPS vers LV95 -->
                <div class="coordinate-section" id="gps-section">
                    <h3><i class="fa fa-globe"></i> Coordonnées GPS (WGS84)</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="test_lat" class="form-label">Latitude</label>
                                <input type="number" id="test_lat" class="form-control" 
                                       value="46.95108" step="0.00000001" min="-90" max="90">
                                <small class="form-text text-muted">Exemple: Berne - 46.95108</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="test_lng" class="form-label">Longitude</label>
                                <input type="number" id="test_lng" class="form-control" 
                                       value="7.43863" step="0.00000001" min="-180" max="180">
                                <small class="form-text text-muted">Exemple: Berne - 7.43863</small>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="testGPStoLV95()">
                        <i class="fa fa-arrow-right"></i> Convertir GPS → LV95
                    </button>
                </div>

                <!-- Section LV95 vers GPS -->
                <div class="coordinate-section" id="lv95-section">
                    <h3><i class="fa fa-mountain"></i> Coordonnées Suisses (LV95)</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="test_easting" class="form-label">Coordonnée Est (E)</label>
                                <input type="number" id="test_easting" class="form-control" 
                                       value="2600000" step="1">
                                <small class="form-text text-muted">Exemple: Berne - 2600000</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="test_northing" class="form-label">Coordonnée Nord (N)</label>
                                <input type="number" id="test_northing" class="form-control" 
                                       value="1200000" step="1">
                                <small class="form-text text-muted">Exemple: Berne - 1200000</small>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="testLV95toGPS()">
                        <i class="fa fa-arrow-left"></i> Convertir LV95 → GPS
                    </button>
                </div>

                <!-- Résultats des tests -->
                <div id="test-results"></div>

                <!-- Tests automatiques -->
                <div class="mt-5">
                    <h3><i class="fa fa-flask"></i> Tests Automatiques</h3>
                    <button class="btn btn-warning" onclick="runAutomaticTests()">
                        <i class="fa fa-play"></i> Lancer les tests automatiques
                    </button>
                    <div id="automatic-test-results"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-info-circle text-info"></i> Informations</h5>
                    </div>
                    <div class="card-body">
                        <h6>Coordonnées de test</h6>
                        <div class="coordinates-display mb-3">
                            <strong>Berne:</strong><br>
                            GPS: 46.95108, 7.43863<br>
                            LV95: 2600000, 1200000
                        </div>
                        
                        <div class="coordinates-display mb-3">
                            <strong>Zurich:</strong><br>
                            GPS: 47.3769, 8.5417<br>
                            LV95: 2683000, 1248000
                        </div>
                        
                        <div class="coordinates-display">
                            <strong>Genève:</strong><br>
                            GPS: 46.2044, 6.1432<br>
                            LV95: 2500000, 1118000
                        </div>

                        <hr>
                        
                        <h6>API Utilisée</h6>
                        <p class="small text-muted">
                            <strong>Swisstopo API REFRAME</strong><br>
                            Service officiel de conversion de coordonnées de l'Office fédéral de topographie
                        </p>
                        
                        <h6>Précision</h6>
                        <p class="small text-muted">
                            La précision des conversions est de l'ordre du centimètre pour la Suisse.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module de conversion -->
    <script src="/js/coordinate-converter.js"></script>
    
    <script>
        let testCount = 0;

        /**
         * Test conversion GPS vers LV95
         */
        async function testGPStoLV95() {
            const lat = parseFloat(document.getElementById('test_lat').value);
            const lng = parseFloat(document.getElementById('test_lng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showTestResult('Erreur: Coordonnées GPS invalides', 'error');
                return;
            }

            try {
                showTestResult('Conversion GPS → LV95 en cours...', 'info');
                
                const result = await window.TopoclimbCoordinateConverter.convertWGS84toLV95(lng, lat);
                
                // Mettre à jour les champs LV95
                document.getElementById('test_easting').value = Math.round(result.easting);
                document.getElementById('test_northing').value = Math.round(result.northing);
                
                // Marquer la section comme valide
                document.getElementById('lv95-section').classList.add('valid');
                
                showTestResult(
                    `✅ Conversion GPS → LV95 réussie!<br>
                    <strong>Entrée:</strong> ${lat}, ${lng}<br>
                    <strong>Résultat:</strong> ${Math.round(result.easting)}, ${Math.round(result.northing)}`, 
                    'success'
                );
                
            } catch (error) {
                showTestResult(`❌ Erreur conversion GPS → LV95: ${error.message}`, 'error');
            }
        }

        /**
         * Test conversion LV95 vers GPS
         */
        async function testLV95toGPS() {
            const easting = parseFloat(document.getElementById('test_easting').value);
            const northing = parseFloat(document.getElementById('test_northing').value);
            
            if (isNaN(easting) || isNaN(northing)) {
                showTestResult('Erreur: Coordonnées LV95 invalides', 'error');
                return;
            }

            try {
                showTestResult('Conversion LV95 → GPS en cours...', 'info');
                
                const result = await window.TopoclimbCoordinateConverter.convertLV95toWGS84(easting, northing);
                
                // Mettre à jour les champs GPS
                document.getElementById('test_lat').value = result.latitude.toFixed(8);
                document.getElementById('test_lng').value = result.longitude.toFixed(8);
                
                // Marquer la section comme valide
                document.getElementById('gps-section').classList.add('valid');
                
                showTestResult(
                    `✅ Conversion LV95 → GPS réussie!<br>
                    <strong>Entrée:</strong> ${easting}, ${northing}<br>
                    <strong>Résultat:</strong> ${result.latitude.toFixed(8)}, ${result.longitude.toFixed(8)}`, 
                    'success'
                );
                
            } catch (error) {
                showTestResult(`❌ Erreur conversion LV95 → GPS: ${error.message}`, 'error');
            }
        }

        /**
         * Tests automatiques avec points de référence
         */
        async function runAutomaticTests() {
            const testPoints = [
                { name: 'Berne', lat: 46.95108, lng: 7.43863, easting: 2600000, northing: 1200000 },
                { name: 'Zurich', lat: 47.3769, lng: 8.5417, easting: 2683000, northing: 1248000 },
                { name: 'Genève', lat: 46.2044, lng: 6.1432, easting: 2500000, northing: 1118000 }
            ];

            const resultsDiv = document.getElementById('automatic-test-results');
            resultsDiv.innerHTML = '<h5>Tests en cours...</h5>';

            let results = '<h5>Résultats des Tests Automatiques</h5>';
            let allPassed = true;

            for (const point of testPoints) {
                try {
                    // Test GPS → LV95
                    const lv95Result = await window.TopoclimbCoordinateConverter.convertWGS84toLV95(point.lng, point.lat);
                    const eastingDiff = Math.abs(lv95Result.easting - point.easting);
                    const northingDiff = Math.abs(lv95Result.northing - point.northing);
                    
                    // Test LV95 → GPS  
                    const gpsResult = await window.TopoclimbCoordinateConverter.convertLV95toWGS84(point.easting, point.northing);
                    const latDiff = Math.abs(gpsResult.latitude - point.lat);
                    const lngDiff = Math.abs(gpsResult.longitude - point.lng);
                    
                    // Vérification de précision (tolérance: 100m pour LV95, 0.001° pour GPS)
                    const lv95Precise = eastingDiff < 100 && northingDiff < 100;
                    const gpsPrecise = latDiff < 0.001 && lngDiff < 0.001;
                    
                    if (lv95Precise && gpsPrecise) {
                        results += `<div class="test-success">✅ <strong>${point.name}</strong> - Tests réussis</div>`;
                    } else {
                        results += `<div class="test-error">❌ <strong>${point.name}</strong> - Précision insuffisante</div>`;
                        allPassed = false;
                    }
                    
                } catch (error) {
                    results += `<div class="test-error">❌ <strong>${point.name}</strong> - Erreur: ${error.message}</div>`;
                    allPassed = false;
                }
            }

            if (allPassed) {
                results += '<div class="test-success"><strong>🎉 Tous les tests sont réussis!</strong><br>L\'API de conversion fonctionne parfaitement.</div>';
            } else {
                results += '<div class="test-error"><strong>⚠️ Certains tests ont échoué</strong><br>Vérifiez la connectivité à l\'API Swisstopo.</div>';
            }

            resultsDiv.innerHTML = results;
        }

        /**
         * Affiche un résultat de test
         */
        function showTestResult(message, type) {
            testCount++;
            const resultsDiv = document.getElementById('test-results');
            
            const className = type === 'success' ? 'test-success' : 
                             type === 'error' ? 'test-error' : 
                             'alert alert-info';
            
            const resultHtml = `
                <div class="${className}">
                    <strong>Test #${testCount}</strong><br>
                    ${message}
                </div>
            `;
            
            resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🗺️ Page de test conversion coordonnées initialisée');
            showTestResult('Page de test prête. Testez les conversions ci-dessus.', 'info');
        });
    </script>
</body>
</html>